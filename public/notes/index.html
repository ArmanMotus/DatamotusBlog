<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Notes - </title>
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "",
    
    "url": "https:\/\/DatamotusBlog.netlify.app\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/DatamotusBlog.netlify.app\/"
  
  
  
  
}
</script>

<meta property="og:url" content="https://DatamotusBlog.netlify.app/notes/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="">
   
<link rel="apple-touch-icon" sizes="180x180" href=" https://DatamotusBlog.netlify.app/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://DatamotusBlog.netlify.app/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://DatamotusBlog.netlify.app/favicon/favicon-16x16.png">


<meta name="generator" content="Hugo 0.113.0"><link rel="alternate" href="https://DatamotusBlog.netlify.app/index.xml" type="application/rss+xml" title="">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://DatamotusBlog.netlify.app/css/main.css">
<link disabled id="dark-mode-theme" rel="stylesheet" href="https://DatamotusBlog.netlify.app/css/dark.css"><link rel="stylesheet" href="https://DatamotusBlog.netlify.app/css/syntax.css"><link rel="stylesheet" href="https://DatamotusBlog.netlify.app/css/codeblock.css">



<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    },
    CommonHTML: { linebreaks: { automatic: true } },
    "HTML-CSS": { linebreaks: { automatic: true } },
    SVG: { linebreaks: { automatic: true } }
  });
</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>







  </head>
  <body>
    









<header class="header-section ">
  

<script>
window.onload = function() {
  
  var currentPathname = window.location.pathname;
  window.parent.postMessage({ pagePath: currentPathname }, '*');
};
</script>

  <div class="intro-header no-img mt-10">
    <div class="container">
      <div class="row justify-content-center">
        

          
          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
            

            <div class="tags-heading">
              
              <h1 class="fw-semibold display-5 lh-1 mb-3">
                
                Notes
              </h1>
              
              

              

              

              
              

              

              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>


    

<div class="container" role="main">
  <div class="row justify-content-md-center">
    

    
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">
    <div class="card mb-3 ">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <h3 class="post-title">Optimization Modeling for Store Product Clustering and EOQ Determination</h3>
                </div>
                <div class="col-md-2 d-flex justify-content-end">
                    <a href="https://DatamotusBlog.netlify.app/notes/2020/optimization_modeling_for_store_product/">
                    <button type="button" class="btn btn-outline-dark">
                        Link
                    </button>
                </a>
                </div>
            </div>

            

            <p class="post-meta">
                <span class="post-meta text-muted">
  
  

  July 10, 2023

  

  

  

  
</span>
            </p>
            
            <div class="post-entry">

                
                <p><img src="../Optimization_Modeling/website6.jpeg" alt="image"></p>
<h3 id="introduction">Introduction</h3>
<h4 id="problem-statement">Problem Statement</h4>
<p>The <em>objective</em> of this study is to develop a robust optimization solution that enables the determination of an optimal replenishment for managing store products. By doing so, store managers can gain valuable insights into the ideal stock levels required to meet customer demand while minimizing holding costs and ensuring efficient inventory management practices. The approach outlined in this article demonstrates the potential to enhance inventory management practices within a retail chain, empowering store managers with accurate and data-driven decision-making capabilities.</p>
<p>Rather than treating each product and store individually, the group of store will be examined. To address the challenge of defining the economic order quantity (EOQ) for each product and group of store, a clustering approach is applied based on the historical data of available inventory across various product types.</p>
<p>The time series clustering is used ensuring that the resulting clusters accurately capture the patterns and trends in inventory levels over time. By clustering stores with similar inventory behaviors, the model can provide recommendations for the optimal number of orders per each cluster and product category.</p>
<p>Furthermore, this study acknowledges that additional complexities can be addressed beyond the basic EOQ determination. Factors such as optimal replenishment frequency, seasonal variations, and monthly EOQ adjustments can be incorporated into the modeling framework, allowing for more flexible and comprehensive solutions tailored to specific store and product characteristics. Thus, by incorporating advanced analytics and considering various factors, future research can build upon this framework to develop even more sophisticated and customized solutions for inventory optimization.</p>
<h4 id="data-description">Data Description</h4>
<p>In this study, we will review a sample dataset obtained from a company specializing in dairy products, focusing on the three most popular types in Armenia. The dataset comprises hourly time series data, covering the period from February 2023 to May 2023, without any missing values. By analyzing this dataset, we aim to gain insights into the availability of dairy products in different stores and explore potential clustering.</p>
<p>The summary of the dataset is presented below.</p>
<p><img src="../Optimization_Modeling/table1.png" alt=""></p>
<p>The dataset consists of six variables: the variable, <code>STORE_ID</code> represents the unique identifiers assigned to each store, with a total of 100 distinct stores in the dataset. The next variable, <code>PRODUCT</code> signify the three types of dairy products under investigation: Milk, Sour Cream, and Matsuni. This variable enable us to focus on the availability patterns of specific product categories across the stores.</p>
<p>The central variable of interest, <code>AVAILABLE</code> records the hourly count of available dairy products in each store. By examining this variable, we can observe fluctuations in stock levels and identify potential trends or seasonality in product availability. The dataset&rsquo;s temporal granularity, captured at an hourly level, provides a detailed perspective on the inventory dynamics within the selected timeframe.</p>
<p>Additionally, the last two variables in the dataset capture the geographic characteristics of the stores. The variable <code>Distance from Yerevan</code> represents the distance of each store from the capital city, Yerevan, in kilometers. This information can help us assess whether proximity to the city has any influence on product availability or demand. The variable <code>Location</code> shows provides insight into the orientation of each store concerning the country&rsquo;s center, further enhancing our understanding of the spatial distribution of the stores.</p>
<p><img src="../Optimization_Modeling/graph1.png" alt=""></p>
<p>From the graph above it appears that the majority of the stores are located in the North part of Yerevan, comprising 65% of the total stores. Additionally, it is noteworthy that the majority of stores are located within a relatively close proximity, approximately within a 25-kilometer radius from Yerevan.</p>
<p>The graph above displays the hourly dynamics of the main variable for three types of products for one store. Analyzing the data, it is evident that the average replenishment frequency for all products is approximately 12 days. The average replenishment frequency of approximately 12 days indicates the store&rsquo;s replenishment cycle, reflecting the time required to restock and maintain adequate inventory levels. This information is essential for optimizing inventory management practices and ensuring that the store can meet customer demand efficiently. Furthermore, it is observed that the average count of available Sour Cream is consistently lower compared to the other products. The contrasting availability levels between Sour Cream and the other products suggest potential differences in consumer preferences or demand patterns. Additionally, noteworthy is the relatively similar availability levels of Milk and Matsuni for this particular store.</p>
<p><img src="../Optimization_Modeling/graph2.png" alt=""></p>
<p>The presented graph illustrates the daily average availability of each product across different regions in the system (in all stores). It becomes apparent that Matsuni exhibits the highest availability, followed by milk, while sour cream demonstrates relatively lower demand. Moreover, it is noteworthy that the distribution of availability among regions is approximately uniform. This observation could potentially be attributed to the fact that livestock serves as the primary source of livestock production in the Republic of Armenia, with cattle breeding accounting for around 95% of milk consumption and nearly 55% of meat consumption.</p>
<p>In the following sections, we will delve deeper into the dataset and apply clustering techniques to unveil meaningful patterns and trends. By doing so, we strive to contribute to the field of inventory management by presenting a robust and data-driven approach for enhancing store product management strategies.</p>
<h3 id="why-dtw-can-be-useful">Why DTW can be useful?</h3>
<p>Dynamic Time Warping (DTW) is a widely used technique for measuring the similarity or distance between two time series data. Unlike the Euclidean distance, which calculates the difference between corresponding points in two time series, DTW takes into account the possible time warping or alignment of the sequences. This makes DTW particularly useful when comparing time series with variations in speed or timing.</p>
<p>The key advantage of DTW over Euclidean distance is its ability to handle time lags or temporal distortions between the compared sequences. In many real-world scenarios, time series data may exhibit variations in speed, phase shifts, or temporal misalignments. Euclidean distance, by strictly comparing corresponding points, may fail to capture the underlying similarities between two time series with such variations. DTW, on the other hand, allows for flexible alignment, warping, and stretching of the sequences to find the best matching pattern.</p>
<p>In the context of availability clustering, DTW is particularly valuable because it enables the comparison of time series data without considering the exact time lag. In inventory management, it is crucial to identify similar availability patterns across different stores, even if they do not align perfectly in terms of the time of occurrence. For instance, a new store might experience a delay in its availability pattern compared to an established store. However, the overall shape or trend of the availability pattern could still be similar. DTW allows us to capture and quantify these similarities, providing a more robust and accurate measure of clustering or similarity between availability patterns.</p>
<p>Moreover, DTW accommodates time series data of varying lengths, making it suitable for cases where the length of the time series may differ across stores or products. This is particularly useful when dealing with stores that have a relatively short sequence of availability data. DTW can effectively align and compare such shorter sequences with longer ones, enabling the identification of similar patterns even in cases where the time series length varies.</p>
<p>By leveraging the advantages of DTW, availability clustering becomes a powerful tool in inventory management. It allows for the identification of stores or products with similar availability patterns, aiding in efficient stock management, demand forecasting, and replenishment strategies. The use of DTW ensures that time lags and temporal distortions are appropriately accounted for, resulting in more accurate clustering and better decision-making processes for optimizing inventory management in diverse retail environments.</p>
<h4 id="dtw-quickstart-example">DTW: Quickstart Example</h4>
<p>For the example data of 2 Stores and 1 Product will be used. To demonstrate the application of Dynamic Time Warping (DTW), the Sakoe-Chiba band^[DTW offers various types of bands, such as Itakura and Sakoe-Chiba, which define constraints for the alignment path. Additionally, bands can be learned from data. For more detailed information on these band types, I recommend referring to the original paper by Sakoe and Chiba or the article titled &ldquo;Dynamic Time Warping: Itakura vs Sakoe-Chiba&rdquo; by Geler, Kurbalija, et al. These resources provide comprehensive insights into the different band approaches and their applications in DTW analysis.] approach is recommended. This method constrains the warping path to reduce time complexity and enforce local alignment. By defining a band around the diagonal of the cost matrix, the alignment search space is limited, allowing for more efficient computations and improved alignment results.</p>
<p>The cost matrix is a fundamental component in DTW, representing the pairwise distances between individual points in the two time series being compared. Each element in the matrix corresponds to the cost of aligning two specific points. The goal of DTW is to find the optimal path through the matrix with the minimum total cost, indicating the best alignment between the time series.</p>
<p><img src="../Optimization_Modeling/graph3.png" alt=""></p>
<p>In the alignment path graph, the diagonal line represents the Euclidean distance, where each time point corresponds to the same time, regardless of DTW. The alignment path, shown as a curve, represents the optimal warping path determined by DTW. It captures the alignment of corresponding points in the two time series, taking into account possible time distortions or shifts.</p>
<p>The graph below (right one) illustrates the alignment between two time series for two stores and one type of product using the Euclidean distance. This straightforward measure compares corresponding points in the time series without considering time distortions. The alignment is achieved by connecting the points directly, resulting in a rigid alignment that may not accurately capture the underlying similarities between the time series.</p>
<p><img src="../Optimization_Modeling/graph4.png" alt=""></p>
<p>In contrast, the right graph demonstrates the alignment between the same two time series using DTW. By allowing for warping and stretching of the sequences, DTW identifies the optimal alignment path that minimizes the total cost. This flexible alignment accounts for potential time distortions and provides a more accurate representation of the similarities between the time series.</p>
<p>The DTW alignment path captures the correspondence between points in the time series, allowing for variations in timing and duration. It enables the identification of similar patterns, even if the time series exhibit differences in speed or temporal alignment. The use of DTW enhances the comparison and clustering of time series data, facilitating more accurate analysis and decision-making in inventory management and other applications.</p>
<p>By leveraging the power of DTW and understanding its alignment capabilities, analysts can uncover valuable insights, identify patterns, and make informed decisions based on the accurate comparison of time series data.</p>
<p><strong>DTW vs Euclidean</strong></p>
<p>To compare the results of Euclidean distance and Dynamic Time Warping (DTW) in measuring similarity between time series, a simple example was considered. The example consists of three time series representing the dynamics of three stores, with one product. Time series from one store (147, red) serving as the reference and the other two (177, 178 - blue, yellow) being compared to find the most similar one.</p>
<p>Upon comparing these time series using both DTW and Euclidean distance metrics, interesting observations were made. When utilizing DTW, the first time series (147) was found to be closer to the third time series (178) in terms of similarity. However, based on the Euclidean distance, the first time series appeared to be closer to the second time series (177).</p>
<p><img src="../Optimization_Modeling/graph5.png" alt=""></p>
<p>This discrepancy in results can be attributed to the ability of DTW to account for temporal distortions and variations in the alignment of corresponding points between time series. While Euclidean distance calculates the direct differences between corresponding points, DTW allows for flexible alignment, taking into consideration time warping and stretching.</p>
<p><img src="../Optimization_Modeling/table2.png" alt=""></p>
<p>The calculated distances further highlight the contrasting results obtained from DTW and Euclidean distance. The observation that the DTW distance is smaller than the Euclidean distance in this example highlights the effectiveness of DTW in capturing the underlying similarity between time series.</p>
<p>These findings demonstrate the importance of selecting an appropriate distance metric when comparing time series data. While Euclidean distance is straightforward and useful in certain scenarios, DTW offers a more robust approach, particularly when dealing with time series that exhibit temporal variations or misalignments.</p>
<h3 id="cluster-analysis-using-multi-dimensional-dtw-for-store-time-series">Cluster Analysis using Multi-Dimensional DTW for Store Time Series</h3>
<p>To cluster the stores based on their time series data for three different products, a <strong>Multi-Dimensional DTW</strong> approach was employed. This involved calculating the distance between the time series of <strong>each product for pairs of stores</strong>, considering not only the distance between two time series but also the distances between the corresponding product time series of two stores. By performing this comparison for all pairs of stores, a <code>\(100\text{x}100\)</code> distance matrix was generated, providing a comprehensive measure of similarity between stores.</p>
<p><img src="../Optimization_Modeling/table3.png" alt=""></p>
<p>Using this distance matrix, k-means clustering was applied to group the stores into clusters. The number of clusters was determined based on the optimal solution, which in this case was found to be four clusters.</p>
<p>The same clustering procedure was repeated using the Euclidean distance metric for comparison. To assess the quality of the clustering results, the between-cluster sum of squares (BSS) and within-cluster sum of squares (WSS) were computed. The BSS measures the separation between clusters, indicating how distinct the clusters are from each other, while the WSS quantifies the compactness of each cluster. By evaluating the BSS and WSS values, we can determine the effectiveness of the clustering approach.</p>
<p>The centroid of each cluster represents the <strong>typical time series</strong> pattern for that cluster. In this case, the centroid products, which are the time series representing the centroid of each cluster, were selected to represent the cluster&rsquo;s characteristics. By examining these centroid products, we can gain insights into the common patterns exhibited within each cluster.</p>
<p>Although the results of the comparison between DTW and Euclidean distances for clustering the store time series were relatively similar, the decision was made to utilize DTW as the preferred distance metric. This choice was based on the unique capabilities of DTW in handling time series data with variations in time alignment. In the context of store time series clustering, DTW provides a more robust measure of similarity.</p>
<p><img src="../Optimization_Modeling/table6.png" alt=""></p>
<p>The results, depicted in the graph above, showcase the four clusters, with each cluster represented separately. Within each cluster, three time series are represented as centroid products, providing a concise summary of the time series patterns for that cluster.</p>
<p>Multi-Dimensional DTW analysis offers a comprehensive understanding of the similarity between store time series for different products.</p>
<p><strong>Describing Product Dynamics</strong></p>
<p>Before delving into a detailed description of the clusters and their geographic characteristics, let&rsquo;s explore the dynamics of each product within the clusters. To achieve this, we will examine the 7-day moving average availability dynamics of each product across the entire system, segmented by clusters. The graph presented below illustrates the time series dynamics for each product (arranged in rows), with the colored lines representing the differences in clusters.</p>
<p>Analyzing the dynamics of Matsuni availability, it becomes evident that clusters 3 and 4 exhibit significantly higher dynamics compared to clusters 1 and 2. This suggests that stores within clusters 3 and 4 have distinct patterns of availability for Matsuni, potentially indicating variations in demand or stocking strategies within these clusters. Similarly, the dynamics of milk availability differ noticeably across the clusters. Cluster 1 stands out with considerably lower availability dynamics compared to the other clusters, implying a distinct pattern in milk availability for the stores within this cluster.</p>
<p><img src="../Optimization_Modeling/graph7.png" alt=""></p>
<p>Turning our attention to Sour Cream, the stores within cluster 3 display a distinctive and higher pattern of availability dynamics compared to stores in the other clusters. This suggests that cluster 3 stores may have unique factors influencing the availability of Sour Cream, such as different sourcing or demand patterns, when compared to the stores in the remaining clusters.</p>
<h3 id="exploring-store-clusters-and-regional-distribution">Exploring Store Clusters and Regional Distribution</h3>
<h4 id="describing-clusters">Describing Clusters</h4>
<p>In this section, we will provide a description of the clusters by utilizing the prototypes or cluster centroids derived from the available time series data. In order to uncover distinct patterns and characteristics to each cluster the 7-day moving average of each product&rsquo;s availability within each cluster will be used.</p>
<p>As mentioned earlier, the availability of dairy products serves as a reliable proxy for understanding consumer demand. In essence, we can use the terms &ldquo;availability&rdquo; and &ldquo;demand&rdquo; interchangeably when discussing dairy product dynamics.</p>
<p><strong>Cluster 1: High Demand for Matsuni and Milk with Low Sour Cream Consumption</strong></p>
<p>The first cluster stands out with a high availability of Matsuni and Milk dynamics, showcasing a relatively similar level of availability for both products. However, the availability of sour cream within this cluster is notably lower. This cluster represents stores with a strong demand for Matsuni and milk, while the demand for sour cream is comparatively lower.</p>
<p><strong>Cluster 2: High Demand and Active Stores</strong></p>
<p>This cluster represents highly active stores with a substantial demand for all three dairy products. Additionally, the general trend of product availability within this cluster is higher, further emphasizing the dynamic nature of these stores.</p>
<p><img src="../Optimization_Modeling/graph8.png" alt=""></p>
<p><strong>Cluster 3: Similar Availability for Milk and Matsuni with Fluctuating Sour Cream Availability</strong></p>
<p>In Cluster 3, the availability of milk and Matsuni displays a similar pattern to that observed in Cluster 1. However, it is worth noting that the availability of sour cream experiences fluctuations around a level of approximately 15, particularly from April onwards. This cluster represents stores where the demand for milk and Matsuni is relatively consistent, while the availability of sour cream exhibits more variability.</p>
<p><strong>Cluster 4: Less Active Stores with Focus on Matsuni Consumption</strong></p>
<p>Cluster 4 comprises the least active stores, characterized by a higher consumption of Matsuni compared to milk and sour cream. The dynamics of milk and sour cream availability in this cluster are relatively low compared to the other clusters. This cluster represents stores where Matsuni consumption takes precedence, with milk and sour cream playing lesser roles.</p>
<h4 id="regional-distribution-of-clusters">Regional Distribution of Clusters</h4>
<p>Moving beyond the analysis of product dynamics, it is equally important to explore the regional distribution of the clusters. This examination sheds light on the characteristics of stores within each region, enabling us to discern the specific types of stores present in different regions.</p>
<p>The geographical analysis reveals interesting patterns in the distribution of clusters across different regions of Armenia. The plot below demonstrates that the South region, encompassing both the West and East areas, predominantly comprises stores belonging to cluster 2, characterized by high activity levels. This suggests that stores situated in the southwestern part of the country exhibit a strong demand for all three products. Conversely, the northeastern region of Armenia accommodates stores from both the most active cluster and the least active cluster.</p>
<p><img src="../Optimization_Modeling/graph9.png" alt=""></p>
<p>Furthermore, a general observation can be made regarding the proximity of stores to Yerevan, the capital city. Stores located in close proximity to Yerevan exhibit higher levels of demand dynamics for all product types, as evident in clusters 1 and 2. In contrast, stores situated farther away demonstrate lower availability levels and less frequent replenishment. This discrepancy can be attributed to the self-sustaining demand of rural areas and less active regions compared to urban centers.</p>
<p>These findings provide valuable insights into the regional distribution of store clusters and the varying dynamics of product availability and demand across different parts of Armenia. By understanding these regional variations, businesses can tailor their strategies to cater to the specific needs and preferences of customers in each area.</p>
<h3 id="optimal-order-quantity-for-each-cluster-and-product">Optimal Order Quantity for each cluster and product</h3>
<p>As mentioned in the introduction, the objective of this research is to address inventory management challenges by determining the optimal quantity of each product for different groups of stores. One of the key concepts utilized in this context is the Economic Order Quantity (EOQ). The EOQ represents the ideal order quantity that minimizes the total inventory costs, taking into account factors such as ordering costs, carrying costs, and demand.</p>
<p>The specific calculation of the EOQ for each product is presented below.</p>
<p><strong>EOQ</strong></p>
<ul>
<li>T = total annual inventory cost</li>
<li>P = purchase unit price, unit production cost</li>
<li>Q = order quantity</li>
<li>Q* = optimal order quantity</li>
<li>D = annual demand quantity</li>
<li>K = fixed cost per order</li>
<li>h = annual holding cost per unit</li>
</ul>
<p>The total cost function and derivation of EOQ formula:</p>
<p><code>$${\displaystyle  \text{Total Cost = Purchase cost + Ordering cost + Holding cost}}$$</code></p>
<ul>
<li>Purchase cost is the variable cost of goods</li>
<li>Ordering cost is the cost of placing orders</li>
<li>Holding cost is the average quantity in stock (between fully replenished and empty) is Q/2</li>
</ul>
<p><code>$${\displaystyle T=PD+K{\frac {D}{Q}}+h{\frac {Q}{2}}}$$</code></p>
<p>Economic order quantity (EOQ) formula is often stated as.</p>
<p><code>$$EOQ = \sqrt{\frac{2DK}{H}}$$</code></p>
<p>Where D is annual demand quantity. Note that Q* is independent of P; it is a function of only K, D, h.</p>
<p>It is important to note that these calculations serve as a simplified demonstration and are not an exhaustive representation of the complexities involved in inventory management. Therefore, the presented EOQ calculations provide a starting point for inventory management optimization. In practice, a more comprehensive approach would consider various factors such as seasonality, dynamic EOQ adjustments, and other relevant considerations. By incorporating these additional factors, a more refined and accurate approach to inventory management can be achieved.</p>
<p><strong>Calculating optimal quantity for Product-Cluster Combinations</strong></p>
<p>In order to determine the optimal quantity (EOQ) for each product in each cluster, several inputs are required. These inputs include the annual demand quantity, fixed cost per order, and annual holding cost per unit. By utilizing these inputs, we can calculate the EOQ values that minimize the total inventory costs and maximize profitability.</p>
<p>The results of these calculations are depicted in the graph below, which illustrates the dynamic demand patterns for each product within each cluster. The solid lines on the graph represent the optimal order quantities determined by the EOQ calculations.</p>
<p><img src="../Optimization_Modeling/graph10.png" alt=""></p>
<p>Understanding the EOQ for each product in each cluster is highly beneficial in terms of inventory control and decision-making. By knowing the optimal order quantities, businesses can avoid excessive stockouts or overstocking, leading to improved customer satisfaction and reduced holding costs. Furthermore, having accurate EOQ values allows businesses to optimize their procurement processes, streamline operations, and allocate resources effectively.</p>
<p>Overall, the utilization of EOQ provides businesses with a statistical approach to inventory management, enabling them to make data-driven decisions that enhance efficiency, profitability, and customer service levels.</p>
<h3 id="conclusion">Conclusion</h3>
<p>In the study, we addressed the problem of inventory management by leveraging clustering techniques and calculating the Economic Order Quantity for different product-cluster combinations. Our aim was to provide insights and solutions for effectively managing inventory in a retail setting.</p>
<p>We utilized a dataset consisting of availability data from 100 stores, each offering three distinct products. By employing Multi-Dimensional Dynamic Time Warping (DTW) techniques, we performed clustering analysis on the time series data to identify similar patterns and group stores accordingly. This allowed us to gain a deeper understanding of the underlying dynamics within the retail system.</p>
<p>Multi-Dimensional DTW analysis offers a comprehensive understanding of the similarity between store time series for different products. Such insights can be instrumental in inventory management, demand forecasting, and decision-making processes within the retail industry. The statistical rigor of this approach ensures a robust analysis of the store time series data, enabling data-driven strategies for store grouping and optimization.</p>
<p>The resulting clusters provided valuable insights into the stores&rsquo; availability dynamics and demand patterns. Each cluster represented a distinct group of stores with unique characteristics. By examining the centroid time series for each cluster, we were able to interpret the behavior and trends specific to the products within those clusters.</p>
<p>Moreover, we calculated the EOQ for each product within each cluster. By considering factors such as annual demand quantity, fixed cost per order, and annual holding cost per unit, we determined the optimal order quantity for inventory replenishment. The EOQ results were plotted alongside the demand dynamics, providing a visual representation of the recommended order quantities for each product-cluster combination.</p>
<p>The implications of this research are significant for businesses operating in the retail industry. By leveraging clustering techniques and EOQ analysis, retailers can effectively allocate resources and optimize their inventory management strategies. The identified clusters provide a basis for targeted decision-making, allowing retailers to tailor their inventory levels and replenishment strategies based on the specific characteristics of each cluster. This, in turn, can lead to improved operational efficiency, reduced costs, and enhanced customer satisfaction.</p>
<h3 id="references">References</h3>
<ol>
<li>Geler Z., Kurbalija V., Ivanovic M., 2019, Radovanovic M., Dai W.,   &ldquo;Dynamic Time Warping: Itakura vs Sakoe-Chiba&rdquo;</li>
<li>Sakoe H., Chiba S., 1978, &ldquo;Dynamic Programming Algorithm Optimization for Spoken Word Recognition&rdquo;</li>
<li>Shokoohi-Yekta M., Hu B., Jin B., Wang J., Keogh E., 2015, &ldquo;Generalizing Dynamic Time Warping to the Multi-Dimensional Case Requires an Adaptive Approach&rdquo;</li>
</ol>

                
            </div>
        </div>
            
            
                <div class="card-footer text-muted">
                   
                
                <div class="blog-tags">
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/data-analysis/">Data Analysis</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/propensity-score-matching/">Propensity Score Matching</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/chess/">Chess</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/experimental-studies/">Experimental Studies</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/bias-in-research/">Bias in Research</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/statistical-methods/">Statistical Methods</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/cognitive-development/">Cognitive Development</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/logical-thinking/">Logical Thinking</a>
                  
                </div>
                
              </div>


 
    </div>
</div>
    
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">
    <div class="card mb-3 ">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <h3 class="post-title">Weighted Least Square</h3>
                </div>
                <div class="col-md-2 d-flex justify-content-end">
                    <a href="https://DatamotusBlog.netlify.app/notes/2020/2019-10-30-weighted-least-squares/">
                    <button type="button" class="btn btn-outline-dark">
                        Link
                    </button>
                </a>
                </div>
            </div>

            

            <p class="post-meta">
                <span class="post-meta text-muted">
  
  

  February 2, 2021

  

  

  

  
</span>
            </p>
            
            <div class="post-entry">

                
                <p><img src="../Weighted_Least_Squares_details/website1.jpeg" alt="image"></p>
<h1 id="introduction">Introduction</h1>
<p>Nowadays, having a business implies օwning a website. The primary aim of
a website is to provide information, which is crucial in the modern
business world. Suppose a website owner aims at increasing the number of
visitors in order to have more views, sales or popularity. To achieve
this goal, one first needs to understand the factors affecting web
traffic. The vast majority of small businesses try to increase website
hits or visits via advertisements.</p>
<p>We took a look at small business website statistics and saw how
important advertising is. Let us review the artificially generated
<a href="../Weighted_Least_Squares_details/website.csv">data</a>. The
summary of the dataset is presented below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>web <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.data.frame</span>(<span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;website.csv&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">summary</span>(web), digits<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Company</th>
<th>Budget</th>
<th>Visits</th>
<th>AdType</th>
</tr>
</thead>
<tbody>
<tr>
<td>Min. : 1.0</td>
<td>Min. : 50.0</td>
<td>Min. :3695</td>
<td>Direct Mail :213</td>
</tr>
<tr>
<td>1st Qu.: 250.8</td>
<td>1st Qu.: 299.8</td>
<td>1st Qu.:4228</td>
<td>Outdoor Ads :199</td>
</tr>
<tr>
<td>Median : 500.5</td>
<td>Median : 549.5</td>
<td>Median :4460</td>
<td>Radio and Podcasts:197</td>
</tr>
<tr>
<td>Mean : 500.5</td>
<td>Mean : 549.5</td>
<td>Mean :4554</td>
<td>Social Media Ads :187</td>
</tr>
<tr>
<td>3rd Qu.: 750.2</td>
<td>3rd Qu.: 799.2</td>
<td>3rd Qu.:4799</td>
<td>Video Ads :204</td>
</tr>
<tr>
<td>Max. :1000.0</td>
<td>Max. :1049.0</td>
<td>Max. :6060</td>
<td></td>
</tr>
</tbody>
</table>
<p>The data consists of 4 variables and 1000 observations without any
missing values. The variable <code>Company</code> shows the unique number of the
company whose website is being examined, variable <code>Visits</code> is the number
of website visits per week. The variables <code>AdType</code> and <code>Budget</code> show the
<strong>main type</strong> of advertising done by the company and the average monthly
amount spent on this advertisement, respectively. There are the 5 types
of advertisement in the data: Radio and Podcasts, Direct Mail, Video
Ads, Social Media Ads, Outdoor Ads.</p>
<p><img src="../Weighted_Least_Squares_details/unnamed-chunk-2-1.png" alt="image"></p>
<p>The left graph indicates that there is a positive correlation between
the money spent on advertisement and the number of website visits. The
coloring of the plot has been done based on the variable <code>AdType</code>, and
the result shows that there is no interaction effect of two explanatory
variables on the popularity of the website. In general, website owners
spend an approximately equal amount of money on different types of
advertisements. Roughly there is no multicollinearity between
explanatory variables. Based on the second graph, as the medians and
spread of data are approximately the same, we can claim that the way one
chooses to increase the visibility of a website plays no significant
role.</p>
<p>To understand the effect of advertising let us consider the following
multiple linear regression model:</p>
<p>$Visits_i = \beta_0 + \beta_1Budget_i + \beta_2AdType_i + \epsilon_i$</p>
<p>The result of fitted linear regression is presented in the output below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>model <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Visits <span style="color:#f92672">~</span> Budget <span style="color:#f92672">+</span> AdType, data <span style="color:#f92672">=</span> web)
</span></span></code></pre></div><table>
<thead>
<tr>
<th></th>
<th>Dependent variable:</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>Visits</td>
</tr>
<tr>
<td>Budget</td>
<td>1.017***   (0.032)</td>
</tr>
<tr>
<td>Outdoor Ads</td>
<td>17.623     (28.957)</td>
</tr>
<tr>
<td>Radio and Podcasts</td>
<td>31.784     (29.003)</td>
</tr>
<tr>
<td>Social Media Ads</td>
<td>-40.288    (29.366)</td>
</tr>
<tr>
<td>Video Ads</td>
<td>-10.368    (28.737)</td>
</tr>
<tr>
<td>Constant</td>
<td>3,995.437*** (26.096)</td>
</tr>
<tr>
<td>Observations</td>
<td>1,000</td>
</tr>
<tr>
<td>R2</td>
<td>0.506</td>
</tr>
<tr>
<td>Adjusted R2</td>
<td>0.504</td>
</tr>
<tr>
<td>Residual Std. Error</td>
<td>293.017 (df = 994)</td>
</tr>
<tr>
<td>F Statistic</td>
<td>203.633*** (df = 5; 994)</td>
</tr>
<tr>
<td>Note</td>
<td>*p&lt;0.1; **p&lt;0.05; ***p&lt;0.01</td>
</tr>
</tbody>
</table>
<p>It is not surprising that the coefficients for the unique levels of
variable <code>AdType</code> are not significant, because there is no effect on the
response variable <code>Visits</code>. However, the coefficient for the variable
<code>Budget</code> is statistically significant and positive (see the graph). So,
the multiple regression analysis shows that with the increase in the
amount of money spent on advertising by $100 the number of visitors
will increase by, on average, 102. Thus, the number of visitors can be
predicted based on the ad budget.</p>
<p>And yet, this is not a reliable result, since an important factor has
been omitted. We will now discuss briefly the concepts of
heteroscedasticity, the causes and effects of nonconstant variance and
the ways of solving this problem.</p>
<h1 id="the-problem">The problem</h1>
<h2 id="nonconstant-variance">Nonconstant variance</h2>
<p>One of the Gauss&ndash;Markov conditions states that the variance of the
disturbance term in each observation should be constant. This
assumption, however, is clearly violated in most of the models resulting
in heteroscedasticity. Mathematically, homoscedasticity and
heteroscedasticity may be defined as:</p>
<ul>
<li><strong>Homoscedasticity:</strong> $\sigma_{\epsilon_i}^2=\sigma_{\epsilon}^2$
the same for all observations</li>
<li><strong>Heteroscedasticity:</strong> $\sigma_{\epsilon_i}^2$ is not the same for
all observations.</li>
</ul>
<p>See the visual demonstration of homoscedasticity and heteroscedasticity
below:</p>
<p><img src="../Weighted_Least_Squares_details/HHSKED.png" alt=""></p>
<p>The left picture illustrates homoscedasticity. Let us start with the
first observation, where $X$ has the value of $X_1$ . If there was no
disturbance term in the model, the observation would be represented by
the circle lied on line $Y = \beta_1+\beta_2X$. The effect of the
disturbance term is to shift the observation upwards or downwards
vertically (downwards in case of $X_1$). The potential distribution of
the disturbance term, before the observation was generated, is shown by
the normal distribution.</p>
<p>Although homoscedasticity is often taken for granted in regression
analysis, it is common to suppose that the distribution of the
disturbance term is different for different observations in the sample.
Suppose the variance of the distribution of the disturbance term rises
as X increases (right picture). This does not mean that the disturbance
term will necessarily have a particularly large (positive or negative)
value in an observation where X is large, but it does mean that the a
priori probability of having an erratic value will be relatively high.</p>
<p>The first graph of the relationship between the budget and visitors
illustrates typical scatter diagram of heteroscedastic data - there is a
tendency for their dispersion to rise as X increases. It means that even
though there is a positive relationship between the variables, starting
at a particular point large amount of money fails to imply a large
number of visitors. In other words, one can spend huge sums without the
guarantee of large traffic.</p>
<blockquote>
<p>Reasons and consequences</p>
</blockquote>
<p>Heteroscedasticity is more likely to occur, for example, when</p>
<ul>
<li>The values of the variables in the sample vary substantially in
different observations.</li>
<li>The explanatory variable increases, the response tends to diverge.
For example, families with low incomes will spend relatively little
on luxury goods, and the variations in expenditures across such
families will be small. But for families with large incomes, the
amount of discretionary income will be higher.</li>
<li>The model is misspecified (using response instead of the log of
response or instead of X^2 using X etc). Important variables may be
omitted from the model.</li>
</ul>
<p>Why does heteroscedasticity matter? As a matter of fact, the evidence
for the absence of bias in the OLS regression coefficients did not use
this condition. So we can be sure that the coefficients are still
unbiased.</p>
<p>Nevertheless, two concerns are raised:</p>
<ul>
<li>
<p><em>The variances of the regression coefficients</em>: if there is no
heteroscedasticity, the OLS regression coefficients have the lowest
variances of all the unbiased estimators that are linear functions
of the observations of $Y$. If heteroscedasticity is present, the
OLS estimators are inefficient because it is possible to find other
estimators that have smaller variances and are still unbiased.</p>
</li>
<li>
<p><em>The estimators of the standard errors of the regression
coefficients</em> will be wrong and, as a consequence, the t-tests as
well as the usual F tests will be invalid. It is quite likely that
the standard errors will be underestimated, so the t statistics will
be overestimated and you will have a misleading impression of the
precision of your regression coefficients. You may be led to believe
that a coefficient is significantly different from 0, at a given
significance level, when, in fact, it is not.</p>
</li>
</ul>
<h2 id="how-to-detect">How to detect</h2>
<p>Since there is no limit to the possible variety of heteroscedasticity, a
large number of different tests appropriate for different circumstances
has been proposed. There are also a lot of statistical tests called to
test whether heteroscedasticity is present. The list includes but is not
limited to the following:</p>
<ul>
<li>The Spearman Rank Correlation Test</li>
<li>The Goldfeld&ndash;Quandt Test</li>
<li>The Glejser Test</li>
<li>The Breusch-Pagan test</li>
<li>The White test</li>
</ul>
<p>Despite the large number of the available tests, we will opt for a
simple technique to detect heteroscedasticity, which is looking at the
residual plot of our model. We can diagnose the heteroscedasticity by
plotting the residual against the predicted response variable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggResidpanel)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">resid_auxpanel</span>(residuals <span style="color:#f92672">=</span> <span style="color:#a6e22e">resid</span>(model), predicted <span style="color:#f92672">=</span> <span style="color:#a6e22e">fitted</span>(model), plots <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;resid&#34;</span>, <span style="color:#e6db74">&#34;index&#34;</span>))
</span></span></code></pre></div><p><img src="../Weighted_Least_Squares_details/unnamed-chunk-5-1.png" alt=""></p>
<p>In our case we can conclude that as budget increases, the website visits
tend to diverge.</p>
<h1 id="the-solution">The solution</h1>
<p>The two most common strategies for dealing with the possibility of
heteroskedasticity is heteroskedasticity-consistent standard errors (or
<a href="http://afhayes.com/public/BRM2007.pdf">robust errors</a>) developed by
White and <strong>Weighted Least Squares</strong>.</p>
<h2 id="wls">WLS</h2>
<p>OLS does not discriminate between the quality of the observations,
giving equal weight to each, irrespective of whether they are good or
poor guides to the location of the line. Thus, it may be concluded that
if we can find a way of assigning more weight to high-quality
observations and less to the unreliable ones, we are likely to obtain a
better fit. In other words, our estimators of $\beta_1$ and $\beta_2$
will be more efficient. WLS works by incorporating extra nonnegative
constants (weights) associated with each data point into the fitting
criterion. We shall see how to do this below. Suppose the true
relationship is $Y_i = \beta_1+\beta_2X_i + \epsilon_i$ and
$[var(\epsilon_i) = \sigma_{\epsilon_i}^2 ]$.</p>
<p>So we have a heteroscedastic model. We could eliminate the
heteroscedasticity by dividing each observation by its value of
$\sigma_{\epsilon_i}$. The model becomes $$\frac{Y_i}{\sigma_{\epsilon_i}} = \beta_1\frac{1}{\sigma_{\epsilon_i}}+\beta_2\frac{X_i}{\sigma_{\epsilon_i}} + \frac{\epsilon_i}{\sigma_{\epsilon_i}}$$</p>
<p>The disturbance term $\frac{\epsilon_i}{\sigma_{\epsilon_i}}$ is
homoscedastic because$$ E[(\frac{\epsilon_i}{\sigma_{\epsilon_i}})^2] = \frac{1}{\sigma_{\epsilon_i}^2}E(\epsilon_i^2)=\frac{1}{\sigma_{\epsilon_i}^2}\sigma_{\epsilon_i}^2=1 $$</p>
<p>Therefore, every observation will have a disturbance term drawn from a
distribution with population variance 1, and the model will be
homoscedastic. By rewriting the model, we will have $Y_i&rsquo; = \beta_1h_i + \beta_2X_i&rsquo;+\epsilon_i&rsquo;$
where: $$Y_i&rsquo;=\frac{Y_i}{\sigma_{\epsilon_i}}, \quad h_i=\frac{1}{\sigma_{\epsilon_i}}, \quad X_i&rsquo;=\frac{X_i}{\sigma_{\epsilon_i}}, \quad \epsilon_i&rsquo;=\frac{\epsilon_i}{\sigma_{\epsilon_i}}$$</p>
<p><strong>Note</strong> that there should not be a constant term in the equation. By
regressing $Y&rsquo;$ on $h$ and $X&rsquo;$, we will obtain efficient estimates of
$\beta_1$ and $\beta_2$ with unbiased standard errors. The general
solution to this is $$\hat{\beta}=(X^TWX)^{-1}(X^TWY),$$</p>
<p>where $W$ is the diagonal martrix with diagonal entries equal to weights
and $Var(\epsilon)=W^{-1}\sigma^2$.</p>
<p>In some cases, the values of the weights may be based on theory or prior
research. In our model, the standard deviations tend to increase as the
value of <code>Budget</code> increases, so the weights tend to decrease as the
value of <code>Budget</code> increases, thus the weights are known. Where the
weights are unknown, we can try different models and choose the best one
based on, for instance, the distribution of the error term. There are
the following common types of situations and weights:</p>
<ul>
<li>
<p>When the variance is proportional to some predictor $x_i$, then
$Var(y_i)=x_i\sigma^2$ thus we set $w_i = 1/x_i$</p>
</li>
<li>
<p>When the $i^{th}$ value of y is an average of $n_i$ observations
$var(y_i)=\frac{\sigma^2}{n_i}$, thus we set $w_i=n_i$ (this
situation often occurs in cluster surveys).</p>
</li>
<li>
<p>When the $i^{th}$ value of y is a total of $n_i$ observations
$var(y_i)={\sigma^2}{n_i}$, thus we set $w_i=1/n_i$.</p>
</li>
</ul>
<p>If the structure of weights is unknown, we have to perform a two-stage
estimation procedure. We need to estimate an ordinary least squares
regression to obtain the estimate of ${\sigma_i^2}$ for $i^{th}$ squared
residual and the absolute value of standard deviation (in case of
outliers). Thus, we can have different weights depending on
${\sigma_i^2}$. Often the weights are determined by fitted values rather
than the independent variable. Let us show these different models via
statistical package R. Fortunately, the R function <code>lm()</code> ,which is used
to perform the ordinary least squares, provides the argument <code>weights</code>
to perform WLS. By default the value of weights in <code>lm()</code> is <code>NULL</code>,
weighted least squares are used with weights <code>weights</code>, minimizing the
sum of $w*e^2$.</p>
<p>Suppose we do not know the pattern of weights, and we want to fit the
models with the following weights:
$$w_i=\frac{1}{x_i} , w_i=\frac{1}{x_i^2}, w_i=\frac{1}{y_i^2}, w=\frac{1}{y_{hat}^2}, w_i=\frac{1}{\sigma_i^2}, w_i=\frac{1}{|\sigma_i|}$$</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>wols1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Visits <span style="color:#f92672">~</span> Budget <span style="color:#f92672">+</span> AdType, data <span style="color:#f92672">=</span> web, weights <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>Budget)
</span></span><span style="display:flex;"><span>wols2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Visits <span style="color:#f92672">~</span> Budget <span style="color:#f92672">+</span> AdType, data <span style="color:#f92672">=</span> web, weights <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>Budget^2)
</span></span><span style="display:flex;"><span>wols3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Visits <span style="color:#f92672">~</span> Budget <span style="color:#f92672">+</span> AdType, data <span style="color:#f92672">=</span> web, weights <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">fitted</span>(model))
</span></span><span style="display:flex;"><span>wols4 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Visits <span style="color:#f92672">~</span> Budget <span style="color:#f92672">+</span> AdType, data <span style="color:#f92672">=</span> web, weights <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">fitted</span>(model)^2)
</span></span><span style="display:flex;"><span>wols5 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Visits <span style="color:#f92672">~</span> Budget <span style="color:#f92672">+</span> AdType, data <span style="color:#f92672">=</span> web, weights <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">resid</span>(model)^2)
</span></span><span style="display:flex;"><span>wols6 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Visits <span style="color:#f92672">~</span> Budget <span style="color:#f92672">+</span> AdType, data <span style="color:#f92672">=</span> web, weights <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">resid</span>(model)))
</span></span></code></pre></div><p>The result of fitted models will be:</p>
<pre><code>## WOLS Results
## =====================================================
##                     Dependent variable: Visits          
##             ----------------------------------------
##               -      1/Budg  1/Budg^2  1/y    1/y^2  1/e^2  1/|e|    
##             (1)      (2)      (3)      (4)    (5)    (6)    (7)     
## -----------------------------------------------------
## Budg     1.017* 1.014* 1.018* 1.015* 1.014* 1.018* 1.014*  
##           (0.032)  (0.024)  (0.022)  (0.031)  (0.031)  (0.001)  (0.008)   
##                                                                                
## Outdoor   17.623   9.016    1.778   17.291   16.927 18.380*** 16.810**  
##          (28.957) (19.540) (10.354) (28.251) (27.531)  (1.405)  (8.426)   
##                                                                                
## Radio     31.784  15.184    1.457   30.884   29.894 31.647* 28.276*  
##          (29.003) (19.823) (10.732) (28.302) (27.591)  (1.562)  (9.309)   
##                                                                                
## Social   -40.288 -10.390   -0.402  -36.504  -32.869 -39.380*** -36.515* 
##          (29.366) (19.315) (10.069) (28.470) (27.571)  (1.498)  (9.223)   
##                                                                                
## Video    -10.368   3.876   11.703   -7.915   -5.622 -8.910***  -8.182   
##          (28.737) (20.532) (12.335) (27.977) (27.217)  (1.597)  (9.493)   
##                                                                                
## Const  3,995.437* 3,993.525* 3,992.827* 3,995.256* 3,995.106* 3,994.459* 3,996.948*
##           (26.096)  (14.600)    (7.216)   (24.978)   (23.908)   (1.388)    (7.472)   
##                                                                                
## -----------------------------------------------------
## Observ   1,000     1,000     1,000     1,000     1,000     1,000       1,000    
## R2       0.506     0.645     0.691     0.517     0.528     1.000       0.940    
## Adj R2   0.504     0.644     0.689     0.515     0.526     1.000       0.939    
## Res SE  293.017   11.263     0.492     4.242     0.061     1.000       14.521   
## F Stat  203.633*  361.792*  444.545*  213.209*  222.603*  585,907.100* 3,091.199*
## =====================================================
## Note: *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01
</code></pre>
<p>Weighted least squares estimates of the coefficients will usually be
nearly the same as the &ldquo;ordinary&rdquo; unweighted estimates. In the models
with explanatory variables such as weight <code>weights = 1/Budget^2</code>
produces the smallest standard errors. The summary of models shows that
the fitted equations are highly similar yet again. Overall, the smallest
standard errors are presented by the model with
<code>weights = 1/resid(model)^2</code>.</p>
<blockquote>
<p>Inverse of x and residuals with weights</p>
</blockquote>
<p>However, as we know the pattern of weight allows to examine the residual
plots for the first two weighted LS models.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">resid_compare</span>(models <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(wols1, wols2),
</span></span><span style="display:flex;"><span>              plots <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;resid&#34;</span>, <span style="color:#e6db74">&#34;index&#34;</span>),
</span></span><span style="display:flex;"><span>              title.opt <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
</span></span></code></pre></div><p><img src="../Weighted_Least_Squares_details/unnamed-chunk-8-1.png" alt=""></p>
<p>Apparently, the nonconstant variance of the residuals still results in
heteroscedasticity. The issue is that the plots above use unweighted
residuals; whereas, with weighted least squares, we need to use weighted
residuals to evaluate the suitability of the model since these take into
account the weights which change variance. The usual residuals fail to
do this and will maintain the same non-constant variance pattern
irrelevant to the weights used in the analysis.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># Weighted residuals by corresponding weight</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">resid_auxpanel</span>(residuals <span style="color:#f92672">=</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>web<span style="color:#f92672">$</span>Budget)<span style="color:#f92672">*</span><span style="color:#a6e22e">resid</span>(wols1), 
</span></span><span style="display:flex;"><span>               predicted <span style="color:#f92672">=</span> <span style="color:#a6e22e">fitted</span>(wols1), 
</span></span><span style="display:flex;"><span>               plots <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;resid&#34;</span>, <span style="color:#e6db74">&#34;index&#34;</span>))
</span></span></code></pre></div><p><img src="../Weighted_Least_Squares_details/unnamed-chunk-9-1.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">resid_auxpanel</span>(residuals <span style="color:#f92672">=</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>web<span style="color:#f92672">$</span>Budget^2)<span style="color:#f92672">*</span><span style="color:#a6e22e">resid</span>(wols2), 
</span></span><span style="display:flex;"><span>               predicted <span style="color:#f92672">=</span> <span style="color:#a6e22e">fitted</span>(wols2), 
</span></span><span style="display:flex;"><span>               plots <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;resid&#34;</span>, <span style="color:#e6db74">&#34;index&#34;</span>))
</span></span></code></pre></div><p><img src="../Weighted_Least_Squares_details/unnamed-chunk-9-2.png" alt=""></p>
<p>It seems that the second WLS model with the following weights
$w_i=\frac{1}{x_i^2}$, because the variability of residuals is the same
for all predicted values. We can now be more confident in results and
state that with every $100 increase in the amount of money spent on
advertising the number of website visitors will rise by, on average,
102. The absence of heteroscedasticity and the fact that the standard
deviation of coefficient is less than in the original model allow to
make predictions with higher level of certainty.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Overall, the weighted ordinary least squares is a popular method of
solving the problem of heteroscedasticity in regression models, which is
the application of the more general concept of <strong>generalized least
squares.</strong> WLS implementation in R is quite simple because it has a
distinct argument for weights. As we saw, weights can be estimated
directly from sample variances of the response variable at each
combination of predictor variables. WLS can sometimes be used where
different observations have been measured by various instruments,
importance or accuracy, and where weights are used to take these
circumstances into account.</p>
<p>The disadvantage of weighted least squares is that the theory behind
this method is based on the assumption that exact weight sizes are
known. However, when it comes to practice, it can be quite difficult to
determine weights or estimates of error variances. Note that WLS is
neither the only nor the best method of addressing the issue of
heteroscedasticity. The alternative methods include estimating
heteroskedasticity-consistent standard errors, and other types of WLS
(e.g. iteratively reweighted least squares).</p>
<hr>
<h1 id="reference-list">Reference List</h1>
<blockquote>
<p><em>Oscar L. Olvera, Bruno D. Zumb, Heteroskedasticity in Multiple
Regression Analysis: What it is, How to Detect it and How to Solve it
with Applications in R and SPSS.</em></p>
</blockquote>
<blockquote>
<p><em>R. Williams,
<a href="https://www3.nd.edu/~rwilliam/stats2/l25.pdf">&ldquo;Heteroskedasticity&rdquo;</a>.</em></p>
</blockquote>

                
            </div>
        </div>
            
            
                <div class="card-footer text-muted">
                   
                
                <div class="blog-tags">
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/weightedleastsquares/">WeightedLeastSquares</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/wls/">WLS</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/r/">R</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/statistics/">Statistics</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/heteroscedasticity/">Heteroscedasticity</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/generalizedleastsquares/">GeneralizedLeastSquares</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/regressionmodels/">RegressionModels</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/dataanalysis/">DataAnalysis</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/iterativelyreweightedleastsquares/">IterativelyReweightedLeastSquares</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/statisticalmethods/">StatisticalMethods</a>
                  
                </div>
                
              </div>


 
    </div>
</div>
    
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">
    <div class="card mb-3 ">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <h3 class="post-title">Shapley Value Regression</h3>
                </div>
                <div class="col-md-2 d-flex justify-content-end">
                    <a href="https://DatamotusBlog.netlify.app/notes/2020/2019-12-20-shapley-value-regression/">
                    <button type="button" class="btn btn-outline-dark">
                        Link
                    </button>
                </a>
                </div>
            </div>

            

            <p class="post-meta">
                <span class="post-meta text-muted">
  
  

  December 20, 2020

  

  

  

  
</span>
            </p>
            
            <div class="post-entry">

                
                <p><img src="../Shapley-value-regression/website2.jpeg" alt="image"></p>
<h2 id="introduction">Introduction</h2>
<p>In marketing research, the problem of multicollinearity can be raised as
a result of using clients&rsquo; rating responses. People tend to answer to
the question of some section/topic in relatively same way. The stronger
the correlations between the explanatory variables, the larger the
population variances of the distributions of their coefficients, and
thus greater the risk of obtaining unreliable coefficients. Although the
estimated coefficients will be unbiased, their high variance will
decrease the $t$ value, which leads to the failure in rejecting the null
hypothesis $H_0:\beta = 0$, and following reduction in the probability
of correctly detecting a non-zero coefficient. However, high correlation
does not necessarily mean having poor estimation: a large number of
observations and sample variances of regressors with a low variance of
the error term can produce good estimates. In the case of
multicollinearity, data do not contain enough information to distinguish
the individual effect of explanatory variables on the dependent
variable. There are a lot of ways for solving the multicollinearity,
here are some of them:</p>
<ul>
<li>Try to reduce disturbance term by including an omitted important
variable in the model.</li>
<li>Increase the number of observations to make standard errors smaller.</li>
<li>Combine the collinear variables together into a single predictor.</li>
<li>Drop one of the problematic variables from the regression.</li>
</ul>
<p>It is often hard to obtain more data, so the first two methods are not
applicable if the design stage of a survey is finished. The last method
of solving the multicollinearity problem involves the risk that some of
the missing variables may indeed belong to the model which can cause
omitted variable bias. In this article, the <a href="https://en.wikipedia.org/wiki/Shapley_value">Shapley
value</a> will be used to
evaluate the importance of each explanatory variable in the model. The
use of Shapley Values comes from the game theory and its purpose is to
evaluate the worth of each player&rsquo;s input over all possible combinations
of players. As stated by Lipovetsky (Lipovetsky,2006), a regression
model can be considered from the perspective of a coalition among
players (predictors) to maximize the total value (quality of fitting).
This approach yields a model called Shapley Value Regression. The case
described in the article adresses customer satisfaction with the
restaurant business. The main purpose will be to detect key drivers in
the restaurant business and to avoid the problem of the high correlation
between variables using this approach.</p>
<h2 id="data-description">Data description</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># load the required libraries used in the article</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">if </span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;pacman&#34;</span>)) <span style="color:#a6e22e">install.packages</span>(<span style="color:#e6db74">&#34;pacman&#34;</span>)
</span></span><span style="display:flex;"><span> pacman<span style="color:#f92672">::</span><span style="color:#a6e22e">p_load</span>(dplyr, readxl, knitr, kableExtra, 
</span></span><span style="display:flex;"><span> networkD3, ggcorrplot, stringr, radiant.data, 
</span></span><span style="display:flex;"><span> textshape, formattable, RColorBrewer, ggraph, igraph)
</span></span></code></pre></div><p>In order to solve the problem of finding the key drivers of the
restaurant industry, a survey was conducted asking customers to complete
a questionnaire covering various aspects of the restaurant.</p>
<p>Below is the description of variables from the synthetic data of
clients&rsquo; responses to a questionnaire that measures how people feel
about the main business drivers for restaurants. People express their
level of satisfaction after using the products of a restaurant. There is
a hierarchy in the data (see the graph below). The variable
<code>Satisfaction</code> will be described with two variables <code>Target 1</code> and
<code>Target 2</code>. These two variables are represented with red dots on the
dendrogram below. These variables, in turn, will be explained by the
<code>Drivers of Targets</code> (blue and light blue dots on the dendrogram) and,
finally, each driver should be explained by <code>items of drivers</code>. Each
<code>Driver of Target</code> has 13 explanatory variables - items of drivers
grouped by a specific color.</p>
<p><img src="../Shapley-value-regression/causalgraph-1.png" alt=""></p>
<p>All variables are observed and collected via survey and measured in
rating scales (1 to 10).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> data_desc <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read_excel</span>(<span style="color:#e6db74">&#34;Shapley_Data_Rest.xlsx&#34;</span>, sheet <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Labels&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kable</span>(data_desc) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, 
</span></span><span style="display:flex;"><span> full_width <span style="color:#f92672">=</span> F, font_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pack_rows</span>(<span style="color:#e6db74">&#34;Drivers of Targets&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">15</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pack_rows</span>(<span style="color:#e6db74">&#34;Items of Drivers&#34;</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">28</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">column_spec</span>(<span style="color:#ae81ff">2</span>, bold <span style="color:#f92672">=</span> T, italic <span style="color:#f92672">=</span> T, width <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5cm&#34;</span>)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Variable Name</th>
<th>Group</th>
<th>Statements (Variable Description)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Satisfaction</td>
<td></td>
<td>Overall satisfaction of customer</td>
</tr>
<tr>
<td>Target 1</td>
<td></td>
<td>A restaurant that enables you to step up in life</td>
</tr>
<tr>
<td>Target 2</td>
<td></td>
<td>A restaurant that allows you to live the life you choose</td>
</tr>
<tr>
<td><strong>Drivers of Targets</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Commitment</td>
<td>Target 1</td>
<td>Showing commitment to people</td>
</tr>
<tr>
<td>Update</td>
<td></td>
<td>Continuously updating restaurant</td>
</tr>
<tr>
<td>Dedication</td>
<td></td>
<td>Sincerely acting in your interest</td>
</tr>
<tr>
<td>Discovering better ways</td>
<td></td>
<td>Discovering better ways to win favor with you</td>
</tr>
<tr>
<td>Fulfill expectation</td>
<td></td>
<td>Focus on fulfilling guest&rsquo;s expectations</td>
</tr>
<tr>
<td>Comfort/relax</td>
<td></td>
<td>Delivering the resources to enable you to feel comfortable and relax</td>
</tr>
<tr>
<td>Guest complaint</td>
<td>Target 2</td>
<td>Taking into consideration guest complaints</td>
</tr>
<tr>
<td>Changing needs</td>
<td></td>
<td>Continuously staying relevant by understanding changing customer needs</td>
</tr>
<tr>
<td>Consumer health</td>
<td></td>
<td>Focus on consumer health</td>
</tr>
<tr>
<td>Menu by norms</td>
<td></td>
<td>Modifying menu items driven by regulatory norms</td>
</tr>
<tr>
<td>Various segments</td>
<td></td>
<td>Work for various customer segments</td>
</tr>
<tr>
<td>New mind-set</td>
<td></td>
<td>Understanding the new consumer mind-set</td>
</tr>
<tr>
<td><strong>Items of Drivers</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Service1</td>
<td>Service</td>
<td>Gives polite and prompt answers/advice to my questions</td>
</tr>
<tr>
<td>Service2</td>
<td></td>
<td>Use state-of-the-art technology (waiters enter order digital system, POS, online payment etc.)</td>
</tr>
<tr>
<td>Service3</td>
<td></td>
<td>Bring an order quickly and properly</td>
</tr>
<tr>
<td>Food1</td>
<td>Food</td>
<td>Serving food</td>
</tr>
<tr>
<td>Food2</td>
<td></td>
<td>Taste of food</td>
</tr>
<tr>
<td>Food3</td>
<td></td>
<td>The variety of menu</td>
</tr>
<tr>
<td>Food4</td>
<td></td>
<td>The quality of food</td>
</tr>
<tr>
<td>Delivery1</td>
<td>Delivery</td>
<td>Preciseness</td>
</tr>
<tr>
<td>Delivery2</td>
<td></td>
<td>Timing</td>
</tr>
<tr>
<td>Delivery3</td>
<td></td>
<td>Quality of food</td>
</tr>
<tr>
<td>Cleanliness1</td>
<td>Cleanliness</td>
<td>Cleanliness in the kitchen</td>
</tr>
<tr>
<td>Cleanliness2</td>
<td></td>
<td>Cleanliness in the hall</td>
</tr>
<tr>
<td>Cleanliness3</td>
<td></td>
<td>Cleanliness in the bathroom</td>
</tr>
</tbody>
</table>
<p>There are a total of 28 questions. Thirteen are about restaurant
service, food, delivery, and cleanliness. For example <code>Service2</code>:
clients are asked to evaluate their satisfaction with the usage of
state-of-the-art technology (waiters enter order digital system, POS,
online payment).</p>
<p>We want to know how the variables relate to the satisfaction of clients
at each level. In each step, the most important variable should be
selected.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read_excel</span>(<span style="color:#e6db74">&#34;Shapley_Data_Rest.xlsx&#34;</span>, sheet <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Data&#34;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">dim</span>(df)
</span></span></code></pre></div><pre><code>## [1] 500  28
</code></pre>
<p>There are 500 respondents who have answered 28 questions in the
synthetic dataset. It can be seen that the ratings are highly
correlated:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">paste</span>(<span style="color:#e6db74">&#34;The correlation between Target 1 and Target 2 is&#34;</span>, <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">cor</span>(df[,<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>])[2],<span style="color:#ae81ff">3</span>))
</span></span></code></pre></div><pre><code>## [1] &quot;The correlation between Target 1 and Target 2 is 0.859&quot;
</code></pre>
<p>There is high correlation between the effort of the restaurant to help
the clients step up in life and its effort to provide the life their
customers choose. The presence of a high correlation between the
independent variables can produce erratic coefficients.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> corfun <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x){corr <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">cor</span>(x), <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ggcorrplot</span>(corr, lab <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;circle&#34;</span>, lab_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">corfun</span>(df[,<span style="color:#ae81ff">4</span><span style="color:#f92672">:</span><span style="color:#ae81ff">9</span>])
</span></span></code></pre></div><!-- raw HTML omitted -->
<p><img src="../Shapley-value-regression/corplot1-1.png" alt=""></p>
<p>The plot above shows the correlation between the drivers of target 1. It
can be seen that the Pearson correlation coefficients for all pairs are
more than 0.73. The highest correlation is between the variables
<code>Dedication</code> (the restaurant is sincerely acting in your interest) and
<code>Comfort/relax</code> (restaurant provides the resources to enable you to feel
comfortable and relaxed).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">corfun</span>(df[,<span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15</span>])
</span></span></code></pre></div><p><img src="../Shapley-value-regression/corplot2-1.png" alt=""></p>
<p>The plot above shows the correlation between the drivers of target 2.
Similarly, there are high correlations between all pairs of variables.
The highest correlation is between the variables <code>Menu by norms</code>
(restaurant modifies menu items driven by regulatory norms) and
<code>Various segments</code> (restaurant works for various customer segments).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">corfun</span>(df[,<span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">28</span>])
</span></span></code></pre></div><p><img src="../Shapley-value-regression/corplot3-1.png" alt=""></p>
<p>Finally, for the last level, the correlation between the items of
drivers is considered. As can be expected, there is high correlation in
each group of items. The highest correlation is between the cleanliness
in the hall and bathroom, followed by the strong correlation between the
taste of food and quality of food, and between the taste of food and the
variety of the menu.</p>
<p>We are going to study Shapley value to detect how it can be used to
avoid multicollinearity and detecting the key driver for the restaurant
industry.</p>
<h2 id="shapley-value-regression">Shapley value regression</h2>
<p>Shapley Value Regression is based on the thesis and post-doctoral work
of an American mathematician and a Nobel Prize-winning economist <a href="https://en.wikipedia.org/wiki/Lloyd_Shapley">Lloyd
Shapley</a> (1953). The
Shapley value is a central solution concept in cooperative game theory.
In order to assess the player&rsquo;s contribution in a game, each individual
player has its own assigned value. The Shapley value associated with
each player in each game has a unique payoff - his &lsquo;value&rsquo; (expected
marginal contribution to a random coalition). The application of this
value in regression analysis is quite intuitive: thisS approach
evaluates the contribution of each regressor variables to the model.
When fitting the multiple linear regression model, the obtained $R^2$
does not show the effect of each variable in explaining the depending
variable (in the cooperative game). To distinguish the contribution made
by the individual member of the game, the Shapley value decomposition
should be used. The share of the regressor variable $x_i$ for a given
set of $k$ predictor variables is given by the following formula:</p>
<p>$$ S({x_i}) = \frac{1}{k} * \sum_{r=1}^{k} * \frac{ \sum_{c=1}^{l} (R^2_{i,r}-R^2_{j,r-1})}{l} $$</p>
<p>where</p>
<ul>
<li>$k$ is the number of regressor variables in the multiple linear
regression model</li>
<li>$R^2_{(i,r)}$ obtained from the model where the regressors are an
r-membered subset of all possible regressors with $i^{th}$ variable</li>
<li>$R^2_{(j,r-1)}$ obtained from the model where the regressors are an
r-membered subset of all possible regressors without $i^{th}$
variable.</li>
</ul>
<p>Suppose we have 3 variables, and we want to obtain Shapley value for the
variable $x_1$. We will have the eight possibilities to fit a linear
regression with these 3 variables: <code>0</code>, <code>x1</code>, <code>x2</code>, <code>x3</code>, <code>x1 x2</code>,
<code>x1 x3</code>, <code>x2 x3</code>, <code>x1 x2 x3</code>. In this case $i=1$, because the
computation is done for $x_1$, $r=3$ and, thus, $r-1=2$, $k=3$ is the
number of cases of possible models, $l$ is the number of models in each
case:</p>
<p><img src="../Shapley-value-regression/Shap1.PNG" alt=""></p>
<!-- raw HTML omitted -->
<p>The weights of the regressions are based on the number of possible
models. We will have</p>
<ul>
<li>2 regressions where $x_1$ is used with one other explanatory
variable: <code>(x1, x2); (x1, x3)</code></li>
<li>1 regression where $x_1$ is used alone <code>(x1)</code></li>
<li>1 regression where $x_1$ is used with two other variables
<code>(x1,x2,x3)</code></li>
</ul>
<p>Thus we will have the following weighted Shapley value for the variable
$x_1$:</p>
<p>$$ SV_{x_1} = \dfrac{1}{3}(R^2_{x_1}-R^2_{\beta_0})+\dfrac{1}{6}(R^2_{x_1;x_2}-R^2_{x_2}) + \dfrac{1}{6}(R^2_{x_1;x_3}-R^2_{x_3}) + \dfrac{1}{3}(R^2_{x_1;x_2;x_3}-R^2_{x_2;x_3}) $$</p>
<!-- raw HTML omitted -->
<p>In order to evaluate the key drivers of restaurant industries, we will
use the regression described above.</p>
<h2 id="implementing-in-r">Implementing in R</h2>
<h2 id="level-1">Level 1</h2>
<p>For the first level, we need to evaluate how the variables <code>Target 1</code> (a
restaurant that enables you to step up in life) and <code>Target 2</code> (a
restaurant that allows you to live the life you choose) explain the
overall satisfaction of the customer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">colnames</span>(df)[2] <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;Target1&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">colnames</span>(df)[3] <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;Target2&#34;</span>
</span></span><span style="display:flex;"><span> reglev1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Satisfaction <span style="color:#f92672">~</span> Target1 <span style="color:#f92672">+</span> Target2, data <span style="color:#f92672">=</span> df)
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">summary</span>(reglev1)
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>## 
## Call:
## lm(formula = Satisfaction ~ Target1 + Target2, data = df)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.2795 -0.7771  0.0047  0.8526  7.0956 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.18626    0.23658   9.241  &lt; 2e-16 ***
## Target1      0.50239    0.06295   7.981 1.01e-14 ***
## Target2      0.21578    0.06381   3.381 0.000778 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.488 on 497 degrees of freedom
## Multiple R-squared:  0.4831, Adjusted R-squared:  0.481 
## F-statistic: 232.2 on 2 and 497 DF,  p-value: &lt; 2.2e-16
</code></pre>
<!-- raw HTML omitted -->
<p>The implemented regression shows that both variables are statistically
significant. And based on estimated coefficients the variable <code>Target 1</code>
is more important. However, we cannot see the relative importance of
each variable by just looking at the summary of linear regression
models. So, the Shapley Values will be used, for both coefficients
separately, to identify the most important driver of clients&rsquo; overall
satisfaction at the first level.</p>
<p>Creating a universal function for Shapley value calculation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>shap <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(formula, var){
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ifelse</span>(<span style="color:#a6e22e">length</span>(<span style="color:#a6e22e">str_split</span>(<span style="color:#a6e22e">paste</span>(formula)[3], 
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;\\s\\+&#34;</span>, simplify <span style="color:#f92672">=</span> T))<span style="color:#f92672">!=</span><span style="color:#ae81ff">1</span>, 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">summary</span>(<span style="color:#a6e22e">lm</span>(data<span style="color:#f92672">=</span>df, formula))<span style="color:#f92672">$</span>r.squared <span style="color:#f92672">-</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">summary</span>(<span style="color:#a6e22e">lm</span>(data<span style="color:#f92672">=</span>df, <span style="color:#a6e22e">as.formula</span>(
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">gsub</span>(<span style="color:#a6e22e">paste0</span>(<span style="color:#a6e22e">paste</span>(formula)[2], <span style="color:#a6e22e">paste</span>(formula)[1],
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">paste</span>(formula)[3]),pattern <span style="color:#f92672">=</span> <span style="color:#a6e22e">paste0</span>(<span style="color:#e6db74">&#34;\\+&#34;</span>, var),
</span></span><span style="display:flex;"><span> replacement <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>))))<span style="color:#f92672">$</span>r.squared, 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">summary</span>(<span style="color:#a6e22e">lm</span>(data<span style="color:#f92672">=</span>df, formula ))<span style="color:#f92672">$</span>r.squared <span style="color:#f92672">-</span> <span style="color:#a6e22e">summary</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lm</span>(data<span style="color:#f92672">=</span>df, <span style="color:#a6e22e">as.formula</span>(<span style="color:#a6e22e">paste0</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">paste</span>(formula)[2],<span style="color:#a6e22e">paste</span>(formula)[1],<span style="color:#ae81ff">1</span>))))<span style="color:#f92672">$</span>r.squared)}
</span></span></code></pre></div><!-- raw HTML omitted -->
<p>We need to calculate the Shapley value for each independent
variable using the functions above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>(ShapValT1 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">shap</span>(
</span></span><span style="display:flex;"><span> formula <span style="color:#f92672">=</span> Satisfaction <span style="color:#f92672">~</span> <span style="color:#f92672">+</span>Target1<span style="color:#f92672">+</span>Target2, var <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Target1&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">shap</span>(formula <span style="color:#f92672">=</span> Satisfaction <span style="color:#f92672">~</span> <span style="color:#f92672">+</span>Target1, 
</span></span><span style="display:flex;"><span>      var <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Target1&#34;</span>))
</span></span></code></pre></div><pre><code>## [1] 0.2687259
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>(ShapValT2 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">shap</span>(
</span></span><span style="display:flex;"><span> formula <span style="color:#f92672">=</span> Satisfaction <span style="color:#f92672">~</span> <span style="color:#f92672">+</span>Target1<span style="color:#f92672">+</span>Target2, var <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Target2&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">shap</span>(formula <span style="color:#f92672">=</span> Satisfaction <span style="color:#f92672">~</span> <span style="color:#f92672">+</span>Target2, 
</span></span><span style="display:flex;"><span>      var <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Target2&#34;</span>))
</span></span></code></pre></div><pre><code>## [1] 0.2084265
</code></pre>
<p>Finally, calculated values are re-based so that they add up to 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>shaplev1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(
</span></span><span style="display:flex;"><span>    ShapValT1 <span style="color:#f92672">=</span> ShapValT1<span style="color:#f92672">/</span>(ShapValT1<span style="color:#f92672">+</span>ShapValT2), 
</span></span><span style="display:flex;"><span>    ShapValT2 <span style="color:#f92672">=</span> ShapValT2<span style="color:#f92672">/</span>(ShapValT1<span style="color:#f92672">+</span>ShapValT2))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">t</span>(shaplev1)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>ShapValT1</th>
<th>0.5631867</th>
</tr>
</thead>
<tbody>
<tr>
<td>ShapValT2</td>
<td>0.4368133</td>
</tr>
</tbody>
</table>
<p>It can be seen that <code>Target 1</code> is the most important at 0.56. In other
words, the overall satisfaction of the customer is mostly described by
the ability of the restaurant to help clients step up in life. We can
decompose the regression and find out what the r-squared is made of and
have a similar result by using the function <code>calc.relimp</code> from the
package <code>relaimpo</code>. The package provides the relative importance metric
<code>lmg</code> introduced by Lindemann, Merenda, and Gold.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">library</span>(relaimpo)
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">calc.relimp</span>(reglev1, type <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;lmg&#34;</span>), 
</span></span><span style="display:flex;"><span>    rela <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, rank <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
</span></span></code></pre></div><pre><code>## Response variable: Satisfaction 
## Total response variance: 4.26796 
## Analysis based on 500 observations 
## 
## 2 Regressors: 
## Target1 Target2 
## Proportion of variance explained by model: 48.31%
## Metrics are normalized to sum to 100% (rela=TRUE). 
## 
## Relative importance metrics: 
## 
##               lmg
## Target1 0.5562547
## Target2 0.4437453
## 
## Average coefficients for different model sizes: 
## 
##                1X       2Xs
## Target1 0.6853051 0.5023914
## Target2 0.6533959 0.2157771
</code></pre>
<p>It can be seen from the table <code>Relative importance metrics:</code> that,
although, the <code>lmg</code> value slightly differs from the above calculated
one, the conclusion is the same.</p>
<h2 id="level-2">Level 2</h2>
<p>To indicate the most important explanatory variable/s for <code>Target 1</code> and
<code>Target 2</code> the drivers of these variables will now be studied. Now, the
variable <code>Target 1</code> and <code>Target 2</code> are dependent on their drivers of the
target correspondingly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> reglev2t1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Target1 <span style="color:#f92672">~</span> td1_1 <span style="color:#f92672">+</span> td1_2 <span style="color:#f92672">+</span> td1_3 <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>        td1_4 <span style="color:#f92672">+</span> td1_5 <span style="color:#f92672">+</span> td1_6, data <span style="color:#f92672">=</span> df)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> reglev2t2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Target2 <span style="color:#f92672">~</span> td2_1 <span style="color:#f92672">+</span> td2_2 <span style="color:#f92672">+</span> td2_3 <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        td2_4 <span style="color:#f92672">+</span> td2_5 <span style="color:#f92672">+</span> td2_6, data <span style="color:#f92672">=</span> df)
</span></span></code></pre></div><!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> shaplev2t1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">calc.relimp</span>(reglev2t1, type <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;lmg&#34;</span>), 
</span></span><span style="display:flex;"><span>              rela <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, rank <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)<span style="color:#f92672">$</span>lmg
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> shaplev2t2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">calc.relimp</span>(reglev2t2, type <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;lmg&#34;</span>), 
</span></span><span style="display:flex;"><span>              rela <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, rank <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)<span style="color:#f92672">$</span>lmg
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> shaplev2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(<span style="color:#a6e22e">cbind</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Commitment&#34;</span>, <span style="color:#e6db74">&#34;Update&#34;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Dedication&#34;</span>, <span style="color:#e6db74">&#34;Discovering better ways&#34;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Fulfill expectation&#34;</span>, <span style="color:#e6db74">&#34;Comfort/relax&#34;</span>), 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">as.numeric</span>(shaplev2t1),<span style="color:#ae81ff">2</span>), <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Guest complaint&#34;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Changing needs&#34;</span>, <span style="color:#e6db74">&#34;Consumer health&#34;</span>, <span style="color:#e6db74">&#34;Menu by norms&#34;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Various segments&#34;</span>, <span style="color:#e6db74">&#34;New mind-set&#34;</span>), 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">as.numeric</span>(shaplev2t2),<span style="color:#ae81ff">2</span>)))
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">colnames</span>(shaplev2) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Var T1&#34;</span>, <span style="color:#e6db74">&#34;Target1&#34;</span>, 
</span></span><span style="display:flex;"><span>                              <span style="color:#e6db74">&#34;Var T2&#34;</span>, <span style="color:#e6db74">&#34;Target2&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>shaplev2 <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rownames_to_column</span>(<span style="color:#e6db74">&#39;shap&#39;</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mutate</span>(Target1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightpink&#34;</span>)(Target1),
</span></span><span style="display:flex;"><span>      Target2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;khaki1&#34;</span>)(Target2)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">column_to_rownames</span>(<span style="color:#e6db74">&#39;shap&#39;</span>) <span style="color:#f92672">%&gt;%</span>    
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">kable</span>(escape <span style="color:#f92672">=</span> F, booktabs <span style="color:#f92672">=</span> T) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">kable_styling</span>( full_width <span style="color:#f92672">=</span> F, font_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">13</span>)
</span></span></code></pre></div><p>In the case of Target 1, the focus of the restaurant on discovering
better ways to win favor with its clients is the most important key
driver for the target variable. For Target 2 (a restaurant that allows
you to live the life you choose) the most two important variables are
the focus of the restaurant on consumer health (actually, the score for
<code>Consumer health</code> is 0.1899209, the score for <code>Menu by norms</code> is
0.1895162).</p>
<p><img src="../Shapley-value-regression/Shap2.PNG" alt=""></p>
<h2 id="level-3">Level 3</h2>
<p>And finally, we will attempt to reveal the most important variable for
each driver of targets. The result from package <code>relaimpo</code> is in the
table below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> shaplev3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sapply</span>(<span style="color:#a6e22e">colnames</span>(df[<span style="color:#f92672">-</span><span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">28</span>)]),
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">function</span>(x){form <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.formula</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">paste0</span>(x,<span style="color:#e6db74">&#34;~Service1 + Service2 + Service3 + Food1 + 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Food2 + Food3 + Food4 + Delivery1 + Delivery2 + 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Delivery3 + Cleanliness1 + Cleanliness2 + Cleanliness3&#34;</span>))
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  reglev3  <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(form, data <span style="color:#f92672">=</span> df)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">calc.relimp</span>(reglev3 , type <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;lmg&#34;</span>), 
</span></span><span style="display:flex;"><span>              rela <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, rank <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)<span style="color:#f92672">$</span>lmg})
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  cn <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">colnames</span>(shaplev3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rownames</span>(shaplev3) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Politeness&#34;</span>, <span style="color:#e6db74">&#34;Technology&#34;</span>, 
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">&#34;Proper order&#34;</span>,<span style="color:#e6db74">&#34;Food serving&#34;</span>, <span style="color:#e6db74">&#34;Food taste&#34;</span>, 
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">&#34;Food variety&#34;</span>,<span style="color:#e6db74">&#34;Food quality&#34;</span>, <span style="color:#e6db74">&#34;Delivery accuracy&#34;</span>, 
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">&#34;Delivery timing&#34;</span>, <span style="color:#e6db74">&#34;Delivery food quality&#34;</span>, 
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">&#34;Clean kitchen&#34;</span>, <span style="color:#e6db74">&#34;Clean hall&#34;</span>, <span style="color:#e6db74">&#34;Clean bathroom&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">data.frame</span>(<span style="color:#a6e22e">round</span>(shaplev3,<span style="color:#ae81ff">2</span>)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rownames_to_column</span>(<span style="color:#e6db74">&#39;shap&#39;</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">mutate</span>(
</span></span><span style="display:flex;"><span>      td1_1 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightgreen&#34;</span>)(td1_1), 
</span></span><span style="display:flex;"><span>      td1_2 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightgreen&#34;</span>)(td1_2),
</span></span><span style="display:flex;"><span>      td1_3 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightgreen&#34;</span>)(td1_3), 
</span></span><span style="display:flex;"><span>      td1_4 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightgreen&#34;</span>)(td1_4),
</span></span><span style="display:flex;"><span>      td1_5 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightgreen&#34;</span>)(td1_5), 
</span></span><span style="display:flex;"><span>      td1_6 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightgreen&#34;</span>)(td2_6),
</span></span><span style="display:flex;"><span>      td2_1 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightblue&#34;</span>)(td2_1), 
</span></span><span style="display:flex;"><span>      td2_2 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightblue&#34;</span>)(td2_2),
</span></span><span style="display:flex;"><span>      td2_3 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightblue&#34;</span>)(td2_3), 
</span></span><span style="display:flex;"><span>      td2_4 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightblue&#34;</span>)(td2_4),
</span></span><span style="display:flex;"><span>      td2_5 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightblue&#34;</span>)(td2_5), 
</span></span><span style="display:flex;"><span>      td2_6 <span style="color:#f92672">=</span><span style="color:#a6e22e">color_tile</span>(<span style="color:#e6db74">&#34;white&#34;</span>,<span style="color:#e6db74">&#34;lightblue&#34;</span>)(td2_6)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">column_to_rownames</span>(<span style="color:#e6db74">&#39;shap&#39;</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rename</span>(<span style="color:#e6db74">&#34;Commitment&#34;</span> <span style="color:#f92672">=</span> cn[1], <span style="color:#e6db74">&#34;Update&#34;</span> <span style="color:#f92672">=</span> cn[2], 
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Dedication&#34;</span> <span style="color:#f92672">=</span> cn[3], <span style="color:#e6db74">&#34;Discovering better ways&#34;</span> <span style="color:#f92672">=</span> cn[4],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Fulfill expectation&#34;</span> <span style="color:#f92672">=</span> cn[5], <span style="color:#e6db74">&#34;Comfort/relax&#34;</span> <span style="color:#f92672">=</span> cn[6], 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Guest complaint&#34;</span> <span style="color:#f92672">=</span> cn[7], <span style="color:#e6db74">&#34;Changing needs&#34;</span> <span style="color:#f92672">=</span> cn[8],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Consumer health&#34;</span> <span style="color:#f92672">=</span> cn[9], <span style="color:#e6db74">&#34;Menu by norms&#34;</span> <span style="color:#f92672">=</span> cn[10], 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Various segments&#34;</span> <span style="color:#f92672">=</span> cn[11], <span style="color:#e6db74">&#34;New mind-set&#34;</span> <span style="color:#f92672">=</span> cn[12]) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">kable</span>(escape <span style="color:#f92672">=</span> F, booktabs <span style="color:#f92672">=</span> T) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">kable_styling</span>( full_width <span style="color:#f92672">=</span> F, font_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">13</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">row_spec</span>(<span style="color:#ae81ff">0</span>, bold <span style="color:#f92672">=</span> T, font_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>)
</span></span></code></pre></div><p><img src="../Shapley-value-regression/Shap3.PNG" alt=""></p>
<p>It seems that <em>politeness</em> of staff is <em>the most important</em> item for all
drivers (for both targets). In other words, the satisfaction of clients
with the staff attitude toward customers has the biggest impact and
makes up to approximately 20% of their argument in your favor. For
almost all drivers the <em>quality of food</em> is the <em>second</em> key item in
terms of importance. The <em>cleanliness in the kitchen</em> is the <em>third</em>
dominant item for drivers like continuously updating restaurants, acting
in the interest of the customer, fulfilling their expectations and
paying attention to consumer health. For the following drivers:
discovering better ways to win favor with the customer, working for
various customer segments <em>the quality of delivery food</em> is the <em>third</em>
important variable. And finally, the <em>accuracy of delivery</em> is important
in the positive assessment of such drivers as delivering the resources
to enable clients to feel comfortable and relax, taking into
consideration guest complaints, understanding the changing needs and a
new mindset of customer and paying attention to consumer health.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Shapley Value Regression is widely used in ranked customer responses,
because of multicollinearity. In order to understand the key drivers of
successful restaurant business the Shapley Value, which shows the
relative importance of predictors, can be used. The idea of Shapley
value regression is in the changes in $R^2$ when the chosen predictor is
removed from the model. So for each regressor, all possible subsets of
the remaining predictors are used to evaluate the regression and the
explanatory variable with the highest additional contribution will be
the most important prediction.</p>
<p>Shapley value assigns relative ranking for each predictor by showing the
dominance of explanatory variables: from the Shapley values regression,
we can conclude that the variable about the ability of restaurant assist
its customers in stepping up in life is the most important in describing
their overall satisfaction. In the second stage analysis, the dominant
variable became the effort of the restaurant to discover better ways to
win favor with clients (for <code>Target 1</code>) and paying attention to
consumer&rsquo;s health is most important for <code>Target 2</code>. Finally, the third
level shows that for this task the politeness of staff mostly impacts
gaining a positive attitude of customers toward the restaurant.</p>
<p>For other types of models (for example generalized linear models:
logistic, Poisson regression, etc.) calculation of $R^2$ is not
appropriate and the approach of using pseudo-$R^2$ or other approached
to calculate the relative weights (see
<a href="https://www.r-bloggers.com/4-reasons-to-compute-importance-using-relative-weights-rather-than-shapley-regression/">here</a>)
will be applied. Also, for the future work adjusted $R^2$ (as number of
regressors in different models is different) instead of $R^2$ can be
considered.</p>
<h2 id="reference-list">Reference List</h2>
<blockquote>
<p>Mishra, S.K. (2016) &ldquo;Shapley value regression and the resolution of
multicollinearity&rdquo;, MPRA, (72116). Available at:
<a href="https://mpra.ub.uni-muenchen.de/72116/">https://mpra.ub.uni-muenchen.de/72116/</a>.</p>
</blockquote>
<blockquote>
<p>Lipovetsky, S. (2006) &ldquo;Entropy Criterion In Logistic Regression And Shapley Value Of
Predictors&rdquo;, Journal of modern applied statistical methods: JMASM</p>
</blockquote>
<blockquote>
<p>Hart S. (1989) Shapley Value. In: Eatwell J., Milgate M., Newman P.
(eds) Game Theory. The New Palgrave. Palgrave Macmillan, London</p>
</blockquote>

                
            </div>
        </div>
            
            
                <div class="card-footer text-muted">
                   
                
                <div class="blog-tags">
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/shapley-value/">shapley value</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/multicollinearity/">multicollinearity</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/relative-importance/">relative importance</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/r-programming/">R programming</a>
                  
                </div>
                
              </div>


 
    </div>
</div>
    
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">
    <div class="card mb-3 ">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <h3 class="post-title">Changes in air pollution</h3>
                </div>
                <div class="col-md-2 d-flex justify-content-end">
                    <a href="https://DatamotusBlog.netlify.app/notes/2020/2020-01-09-changes-in-air-pollution/">
                    <button type="button" class="btn btn-outline-dark">
                        Link
                    </button>
                </a>
                </div>
            </div>

            

            <p class="post-meta">
                <span class="post-meta text-muted">
  
  

  January 9, 2020

  

  

  

  
</span>
            </p>
            
            <div class="post-entry">

                
                <p><img src="../Changes-in-air-pollution/website5.jpeg" alt="image"></p>
<h2 id="introduction">Introduction</h2>
<p>Even without visible smog, air pollution is all around us, and thus it
is hard to eliminate the health effects of the toxic contaminators on
health. The harmful effect of air pollutants is widely investigated in
different researches conducted in many regions of the world. Air
pollutants can be the cause of death from stroke, lung cancer, and
another heart disease. Air pollution has a pernicious effect on children
and it trigger childhood cancer. All over the world, up to 14% of 5 &ndash;
18 years-old children have asthma relating to factors including air
pollution (see <a href="https://www.who.int/airpollution/news-and-events/how-air-pollution-is-destroying-our-health">World Health
Organisation</a>
for details). Besides, air pollution drives <strong>climate change</strong> (the main
driver of climate change is fossil fuel combustion), which itself can be
the problem for well-being.</p>
<p>An assessment by WHO concluded that, in 2016, 91% of the world
population was living in places where the WHO air quality guidelines
levels were not met. In order to protect public health, WHO created air
quality standards, which suggest limits for four main air pollutants.
According to <a href="https://apps.who.int/iris/bitstream/handle/10665/69477/WHO_SDE_PHE_OEH_06.02_eng.pdf?sequence=1">WHO Air quality
guidelines</a>
estimates, air pollution is the cause of 3 million deaths per year. The
evaluation of WHO shows, that the death caused by air pollution can be
decreased by around 15% as a result of reduction in particulate matter
(PM10) pollution from 70 to 20 micrograms per cubic meter.</p>
<p>Many countries fail to monitor pollutant concentrations in the air.
However, now a combination of satellite data, air transport models and
local meteorological conditions can provide a good evaluation of air
quality. Outdoor air pollution can be defined as the emission of harmful
substances into the atmosphere. This broad definition, encapsulates a
number of pollutants, including:</p>
<ul>
<li>sulphur dioxide ($SO_2$),</li>
<li>nitrogen oxides ($NO_x$),</li>
<li>ozone ($O_3$),</li>
<li>particulate matter,</li>
<li>carbon monoxide ($CO$)</li>
<li>carbon dioxide ($CO_2$)</li>
<li>and volatile organic compounds ($VOC_s$).</li>
</ul>
<h1 id="data-description">Data description</h1>
<p>We took the historical data of emissions of the following four types of
pollutants: <a href="https://ourworldindata.org/co2-and-other-greenhouse-gas-emissions">carbon
dioxide</a>,
<a href="https://ourworldindata.org/grapher/so-emissions-per-capita-tonnes-per-year">sulphur
dioxide</a>
per person, <a href="https://ourworldindata.org/air-pollution">particulate
matter</a> measuring less than
2.5µm (micrometers) in diameter,
<a href="https://ourworldindata.org/grapher/ozone-o3-concentration-in-ppb?country=CHN+JPN+SAU+SWE+USA+ZWE">ozone</a>
based on territorial emissions derived by <a href="https://ourworldindata.org/">Our World in
Data</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#75715e"># load the required libraries used in the article</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">if </span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;pacman&#34;</span>)) <span style="color:#a6e22e">install.packages</span>(<span style="color:#e6db74">&#34;pacman&#34;</span>)
</span></span><span style="display:flex;"><span> pacman<span style="color:#f92672">::</span><span style="color:#a6e22e">p_load</span>(ggplot2, dplyr, kableExtra, tidyverse, 
</span></span><span style="display:flex;"><span> magrittr, ggmap, ggpubr, stringr,    RColorBrewer, reshape2)
</span></span></code></pre></div><p>The variables <code>Entity</code> and <code>Code</code> show the country and/ or area and its
code, where the level of a particular pollutant was measured.</p>
<h3 id="carbon-dioxide-co2">Carbon dioxide (CO2)</h3>
<pre tabindex="0"><code>  co &lt;- read.csv(&#34;co.csv&#34;)
  range(unique(co$Year))
</code></pre><pre tabindex="0"><code> [1] 1800 2017
</code></pre><p>The number of observations in the initial data is 16739 and the covered
time span is 1800-2017. Data contains 194 countries.</p>
<p>The variable <code>Co2</code> shows the tonnes of measured carbon dioxide data has
been converted from tonnes of carbon to tonnes of carbon dioxide
($CO_2$) using a conversion factor of 3.664). Carbon Dioxide commonly
enters the body through breathing indoor and outdoor air, vehicle
exhaust, and fumes from heating or cooking and via skin contact -
touching dry ice. Carbon dioxide can cause suffocation, incapacitation
and unconsciousness, vertigo and double vision, headaches, inability to
concentrate, tinnitus and seizures. The long-term exposure of $CO_2$ can
cause changes in bone calcium and body metabolism. When levels of CO2
rise and there is less fresh air, it <a href="https://www.airthings.com/es/what-is-carbon-dioxide">can
cause</a>
restlessness, drowsiness and more. High levels are directly correlated
to low productivity, high sick leave and infectious disease
transmission.</p>
<p>The acceptable level of $CO_2$ in the air is 400ppm (ppm is parts per
million). The level of 2000ppm can cause symptoms like sweating,
increased heart rate and difficulty during breathing will occur.</p>
<p>The summary of carbon dioxide emissions is represented below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">summary</span>(co<span style="color:#f92672">$</span>Co2)
</span></span></code></pre></div><pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.000   0.201   1.071   3.555   4.503 252.645
##    Sulphur dioxide (SO2)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> so <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;so.csv&#34;</span>)
</span></span></code></pre></div><p>The number of observations in the initial data is 2079 and the covered
time span is 1850-2000 (represented by decades). Data contains 130
countries.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">range</span>(<span style="color:#a6e22e">unique</span>(so<span style="color:#f92672">$</span>Year))
</span></span></code></pre></div><pre><code>## [1] 1850 2000
</code></pre>
<p>The variable <code>So2</code> shows the tonnes of measured emissions per capita
(1850-2000). One of the main causes of $SO_2$ emissions is the use of
coal as a source of energy. $SO_2$ emissions sharply rise after
industrialisation: the increase in emission is as a result of
large-scale burning of sulphur-containing fuels and industrial
processing.</p>
<p>Sulfure dioxide can be the cause of health problems like asthma,
bronchial symptoms, lung inflammation, reduced lung function and causes
irritation of the eyes. Sulfuric acid (combination of $SO2$ and water)
is the main component of acid rain which is the cause of deforestation.
The guideline values for sulfure dioxide is 20 $\frac{mg}{m^3}$ 24-hour
mean.</p>
<p>The summary of sulphur dioxide emissions is represented below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">summary</span>(so<span style="color:#f92672">$</span>So2)
</span></span></code></pre></div><pre><code>##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
## 0.0000167 0.0002001 0.0015000 0.0178443 0.0162977 0.4250609
## Particulate matter (PM)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> pm <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;pm.csv&#34;</span>)
</span></span></code></pre></div><p>The number of observations in the initial data is 2090 and the covered
time span is 1990-2016 (the frequency of the data is not regular). Data
contains 189 countries.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>  <span style="color:#a6e22e">range</span>(<span style="color:#a6e22e">unique</span>(pm<span style="color:#f92672">$</span>Year))
</span></span></code></pre></div><pre><code>## [1] 1990 2016
</code></pre>
<p>The variable <code>PM</code> shows the average level of exposure of a nation&rsquo;s
population to concentrations of suspended particles measuring less than
2.5 microns in aerodynamic diameter. The calculations had been done by
using weighting mean annual concentrations of PM2.5 by population.
Actually, one of the most harmful air pollutant is a particulate matter,
which is capable of penetrating deep into the respiratory tract and
increases the risk of heart, respiratory diseases and lung cancer. This
pollutant can originate from natural or man-made sources, mainly from
fuel combustion and road traffic. According to the WHO Air Quality
Guideline the limits for PM is 10 $\frac{mg}{m^3}$ annual mean.</p>
<p>The summary of this variable is represented below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>  <span style="color:#a6e22e">summary</span>(pm<span style="color:#f92672">$</span>PM)
</span></span></code></pre></div><pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   3.291  15.199  21.950  30.160  37.624 203.744

## Ozone (O3)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> oz <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;oz.csv&#34;</span>)
</span></span></code></pre></div><p>The number of observations in the initial data is 1316 and the covered
time span is 1990-2015 (the frequency of the data is not regular). Data
contains 188 countries.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">range</span>(<span style="color:#a6e22e">unique</span>(oz<span style="color:#f92672">$</span>Year))
</span></span></code></pre></div><pre><code>## [1] 1990 2015
</code></pre>
<p>The variable <code>OZ</code> shows population-weighted ozone ($O_3$) concentration
by country (1990-2015) in parts per billion (ppb). As source states,
data is gathered based on a combination of air quality observations from
satellites combined with information from global chemical transport
models, and available ground measurements. A global chemical transport
model was used to calculate a seasonal (summer, when temperatures are
highest) average concentration. Taking into account the population in
each block within a country, this data is then aggregated as estimated
exposure concentrations to national-level population-weighted averages
for a given year.</p>
<p>Ozone is can be the cause of asthma or the cause of making it worse.
Ozone is mainly caused by the reaction of sunlight with pollutants from
vehicle emissions. Ozone is major constituents of photochemical smog.
The highest levels of ozone pollution occur during periods of sunny
weather. According to the WHO Air Quality Guideline the limits for ozone
is 100 $\frac{mg}{m^3}$ 8-hour mean.</p>
<p>The summary of the level of ozone concentration is represented below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">summary</span>(oz<span style="color:#f92672">$</span>OZ)
</span></span></code></pre></div><pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    5.00   45.00   54.00   54.55   63.00  116.00
</code></pre>
<h2 id="categorizationgrouping">Categorization/Grouping</h2>
<p>In order to see the changes in air pollution worldwide, let us
categorize pollutants, by using unequal-size groups. As in the equal
categorization groups with extreme values contain only a few
observations, the extremal values are included in the same group (the
last or the first). See the code below for grouping four above-mentioned
pollutant types; the new variable <code>group</code> for each data will be created.</p>
<h2 id="creating-groups">Creating groups</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> co<span style="color:#f92672">$</span>group <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cut</span>(co<span style="color:#f92672">$</span>Co2, breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1.5</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">12.5</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">37.5</span>, <span style="color:#a6e22e">max</span>(co<span style="color:#f92672">$</span>Co2)))
</span></span><span style="display:flex;"><span> so<span style="color:#f92672">$</span>group <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cut</span>(so<span style="color:#f92672">$</span>So2, breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.001</span>, <span style="color:#ae81ff">0.017</span>, <span style="color:#ae81ff">0.034</span>, <span style="color:#ae81ff">0.07</span>, <span style="color:#ae81ff">0.2</span>, <span style="color:#a6e22e">max</span>(so<span style="color:#f92672">$</span>So2)))
</span></span><span style="display:flex;"><span> pm<span style="color:#f92672">$</span>group <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cut</span>(pm<span style="color:#f92672">$</span>PM, breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(pm<span style="color:#f92672">$</span>PM), <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">44.7</span>, <span style="color:#ae81ff">65.4</span>, <span style="color:#ae81ff">86.1</span>, <span style="color:#a6e22e">max</span>(pm<span style="color:#f92672">$</span>PM)))
</span></span><span style="display:flex;"><span> oz<span style="color:#f92672">$</span>group <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cut</span>(oz<span style="color:#f92672">$</span>OZ, breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(oz<span style="color:#f92672">$</span>OZ), <span style="color:#ae81ff">34.9</span>, <span style="color:#ae81ff">45.7</span>, <span style="color:#ae81ff">56.6</span>, <span style="color:#ae81ff">67.4</span>, <span style="color:#ae81ff">78.3</span>, <span style="color:#a6e22e">max</span>(oz<span style="color:#f92672">$</span>OZ)))
</span></span><span style="display:flex;"><span> gr <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(<span style="color:#a6e22e">table</span>(co<span style="color:#f92672">$</span>group), <span style="color:#a6e22e">rbind</span>(<span style="color:#a6e22e">data.frame</span>(<span style="color:#a6e22e">table</span>(so<span style="color:#f92672">$</span>group)), <span style="color:#a6e22e">c</span>(<span style="color:#66d9ef">NA</span>, <span style="color:#66d9ef">NA</span>)), 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">rbind</span>(<span style="color:#a6e22e">data.frame</span>(<span style="color:#a6e22e">table</span>(pm<span style="color:#f92672">$</span>group)), <span style="color:#a6e22e">c</span>(<span style="color:#66d9ef">NA</span>, <span style="color:#66d9ef">NA</span>)), 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">rbind</span>(<span style="color:#a6e22e">data.frame</span>(<span style="color:#a6e22e">table</span>(oz<span style="color:#f92672">$</span>group)), <span style="color:#a6e22e">c</span>(<span style="color:#66d9ef">NA</span>, <span style="color:#66d9ef">NA</span>)))
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">colnames</span>(gr) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;CO2&#34;</span>, <span style="color:#e6db74">&#34;Freq CO2&#34;</span>, <span style="color:#e6db74">&#34;SO2&#34;</span>, <span style="color:#e6db74">&#34;Freq SO2&#34;</span>, <span style="color:#e6db74">&#34;PM&#34;</span>, <span style="color:#e6db74">&#34;Freq PM&#34;</span>, <span style="color:#e6db74">&#34;OZ&#34;</span>, <span style="color:#e6db74">&#34;Freq OZ&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(gr, digits <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>CO2</th>
<th>Freq CO2</th>
<th>SO2</th>
<th>Freq SO2</th>
<th>PM</th>
<th>Freq PM</th>
<th>OZ</th>
<th>Freq OZ</th>
</tr>
</thead>
<tbody>
<tr>
<td>(0,1.5]</td>
<td>8936</td>
<td>(0,0.001]</td>
<td>970</td>
<td>(3.29,12]</td>
<td>330</td>
<td>(5,34.9]</td>
<td>67</td>
</tr>
<tr>
<td>(1.5,3]</td>
<td>1970</td>
<td>(0.001,0.017]</td>
<td>598</td>
<td>(12,24]</td>
<td>803</td>
<td>(34.9,45.7]</td>
<td>276</td>
</tr>
<tr>
<td>(3,6]</td>
<td>2106</td>
<td>(0.017,0.034]</td>
<td>186</td>
<td>(24,44.7]</td>
<td>527</td>
<td>(45.7,56.6]</td>
<td>377</td>
</tr>
<tr>
<td>(6,12.5]</td>
<td>2365</td>
<td>(0.034,0.07]</td>
<td>176</td>
<td>(44.7,65.4]</td>
<td>265</td>
<td>(56.6,67.4]</td>
<td>391</td>
</tr>
<tr>
<td>(12.5,25]</td>
<td>698</td>
<td>(0.07,0.2]</td>
<td>128</td>
<td>(65.4,86.1]</td>
<td>93</td>
<td>(67.4,78.3]</td>
<td>161</td>
</tr>
<tr>
<td>(25,37.5]</td>
<td>146</td>
<td>(0.2,0.425]</td>
<td>21</td>
<td>(86.1,204]</td>
<td>71</td>
<td>(78.3,116]</td>
<td>41</td>
</tr>
<tr>
<td>(37.5,253]</td>
<td>94</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="maps">Maps</h2>
<p>When the groups are created, the results can be shown using the world
map. We are going to use the function <code>map_data()</code> which contains the
data to create a world map.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> map.world <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">map_data</span>(<span style="color:#e6db74">&#34;world&#34;</span>)
</span></span></code></pre></div><h2 id="co2">Co2</h2>
<p>In order to use the information from the built-in data (especially data
about the longitude and latitude of locations to plot countries as
polygons) the names of countries must be exactly the same, thus the
names in our data should be changed. As there were dissimilarities
between country names in the data world and our data, the changes had
been inspected. The code below shows the difference between country
names in both data. As data is cleaned, there is no difference between
the countries names. The detection of dissimilarities for further 3 data
will be done in the same way.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#75715e"># Detect dissimilarities</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">unique</span>(<span style="color:#a6e22e">na.omit</span>(co<span style="color:#f92672">$</span>Entity))<span style="color:#a6e22e">[c</span>(<span style="color:#a6e22e">which</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">unique</span>(<span style="color:#a6e22e">na.omit</span>(co<span style="color:#f92672">$</span>Entity)) <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">unique</span>(<span style="color:#a6e22e">na.omit</span>(map.world<span style="color:#f92672">$</span>region))))]
</span></span></code></pre></div><pre><code>## factor(0)
## 193 Levels: Afghanistan Albania Algeria Andorra Angola ... Zimbabwe
</code></pre>
<p>Then, these two separate datasets should be joined together.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> map.world_joined <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(co, map.world, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#39;Entity&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;region&#39;</span>))
</span></span></code></pre></div><p>Now, we are going to plot the changes in the data. The reference year
for Co2 is chosen as 2011. In the remaining three plots only the
countries with changes are shown (with respect to the base year).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> themeplot <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">theme</span>(text <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Gill Sans&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>), 
</span></span><span style="display:flex;"><span>   legend.key.size <span style="color:#f92672">=</span> <span style="color:#a6e22e">unit</span>(<span style="color:#ae81ff">0.5</span>, <span style="color:#e6db74">&#34;lines&#34;</span>), panel.grid <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_blank</span>(), 
</span></span><span style="display:flex;"><span>   plot.title <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>), plot.subtitle <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>), 
</span></span><span style="display:flex;"><span>   axis.text <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_blank</span>(), axis.title <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_blank</span>(), 
</span></span><span style="display:flex;"><span>     axis.ticks <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_blank</span>(), legend.position <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), legend.justification <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, 
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">0</span>), legend.title <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_blank</span>())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span> finalplot <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(base <span style="color:#f92672">=</span> <span style="color:#ae81ff">2011</span>, current <span style="color:#f92672">=</span> <span style="color:#ae81ff">2014</span>, var <span style="color:#f92672">=</span> Co2, data <span style="color:#f92672">=</span> map.world_joined, 
</span></span><span style="display:flex;"><span>    initialdata <span style="color:#f92672">=</span> co) {
</span></span><span style="display:flex;"><span>    var <span style="color:#f92672">=</span> <span style="color:#a6e22e">enquo</span>(var)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">if </span>(base <span style="color:#f92672">==</span> current) {
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">is.na</span>(<span style="color:#f92672">!!</span>var)) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> base) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">geom_polygon</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> long, y <span style="color:#f92672">=</span> lat, group <span style="color:#f92672">=</span> group.y, fill <span style="color:#f92672">=</span> group.x)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">scale_fill_brewer</span>(palette <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Set1&#34;</span>) <span style="color:#f92672">+</span> themeplot <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">labs</span>(subtitle <span style="color:#f92672">=</span> <span style="color:#a6e22e">paste</span>(base)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">geom_path</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> long, y <span style="color:#f92672">=</span> lat, group <span style="color:#f92672">=</span> group.y))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        save <span style="color:#f92672">&lt;-</span> initialdata <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> base <span style="color:#f92672">|</span> Year <span style="color:#f92672">==</span> current) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">==</span> <span style="color:#a6e22e">lag</span>(Entity), group <span style="color:#f92672">!=</span> <span style="color:#a6e22e">lag</span>(group)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">left_join</span>(., map.world, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(Entity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;region&#34;</span>))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        save <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">geom_polygon</span>(data <span style="color:#f92672">=</span> map.world, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> long, y <span style="color:#f92672">=</span> lat, 
</span></span><span style="display:flex;"><span>            group <span style="color:#f92672">=</span> group), fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gray81&#34;</span>) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">geom_polygon</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> long, y <span style="color:#f92672">=</span> lat, 
</span></span><span style="display:flex;"><span>            group <span style="color:#f92672">=</span> group.y, fill <span style="color:#f92672">=</span> group.x)) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">scale_fill_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">brewer.pal</span>(n <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, 
</span></span><span style="display:flex;"><span>            name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Set1&#34;</span>)<span style="color:#a6e22e">[as.numeric</span>(<span style="color:#a6e22e">sort</span>(<span style="color:#a6e22e">unique</span>(save <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">select</span>(group.x) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">pull</span>())))]) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>            themeplot <span style="color:#f92672">+</span> <span style="color:#a6e22e">labs</span>(subtitle <span style="color:#f92672">=</span> <span style="color:#a6e22e">paste</span>(current)) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">geom_path</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>, 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> long, y <span style="color:#f92672">=</span> lat, group <span style="color:#f92672">=</span> group.y))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To see the changes in two directions (increase <em>or</em> decrease), we need
to create functions that extract from the initial data the name of the
country which experienced increase or decrease, the year of change and
the group:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> returndataup <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(data, base, current) {
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>     data <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> base <span style="color:#f92672">|</span> Year <span style="color:#f92672">==</span> current) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">==</span> <span style="color:#a6e22e">lag</span>(Entity), <span style="color:#a6e22e">as.numeric</span>(group) <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">as.numeric</span>(<span style="color:#a6e22e">lag</span>(group))) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">left_join</span>(., map.world, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(Entity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;region&#34;</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">distinct</span>(Entity, .keep_all <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group.x)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> returndatadown <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(data, base, current) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>     data <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> base <span style="color:#f92672">|</span> Year <span style="color:#f92672">==</span> current) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">==</span> <span style="color:#a6e22e">lag</span>(Entity), <span style="color:#a6e22e">as.numeric</span>(group) <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">as.numeric</span>(<span style="color:#a6e22e">lag</span>(group))) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">left_join</span>(., map.world, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(Entity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;region&#34;</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">distinct</span>(Entity, .keep_all <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group.x)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And, finally, using the function above the changes can be detected on
the created map:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">annotate_figure</span>(<span style="color:#a6e22e">ggarrange</span>(<span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2011</span>), <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2013</span>), 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2015</span>), <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2017</span>), ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, nrow <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, common.legend <span style="color:#f92672">=</span> F),
</span></span><span style="display:flex;"><span>   top <span style="color:#f92672">=</span> <span style="color:#a6e22e">text_grob</span>(<span style="color:#e6db74">&#34;Carbon dioxide emissions in 2011, 2013, 2015 and 2017&#34;</span>, 
</span></span><span style="display:flex;"><span>   face <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>))
</span></span></code></pre></div><p><img src="../Changes-in-air-pollution/cogr-1.png" alt=""></p>
<p>Countries that experienced an increase in the level of carbon dioxide
emissions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> coup <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(co<span style="color:#f92672">%&gt;%</span><span style="color:#a6e22e">select</span>(Entity, Year, group)<span style="color:#f92672">%&gt;%</span><span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">2011</span>)<span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), <span style="color:#a6e22e">returndataup</span>(co, <span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2013</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">returndataup</span>(co, <span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2015</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">returndataup</span>(co, <span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2017</span>))<span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">arrange</span>(Entity)<span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x) 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(coup<span style="color:#f92672">%&gt;%</span><span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(coup<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity<span style="color:#f92672">~</span>Year))<span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>2011</th>
<th>2013</th>
<th>2015</th>
<th>2017</th>
</tr>
</thead>
<tbody>
<tr>
<td>Andorra</td>
<td>(3,6]</td>
<td></td>
<td>(6,12.5]</td>
<td>(6,12.5]</td>
</tr>
<tr>
<td>Bahamas</td>
<td>(3,6]</td>
<td>(6,12.5]</td>
<td>(6,12.5]</td>
<td>(6,12.5]</td>
</tr>
<tr>
<td>Botswana</td>
<td>(1.5,3]</td>
<td></td>
<td>(3,6]</td>
<td>(3,6]</td>
</tr>
<tr>
<td>India</td>
<td>(0,1.5]</td>
<td>(1.5,3]</td>
<td>(1.5,3]</td>
<td>(1.5,3]</td>
</tr>
<tr>
<td>Kyrgyzstan</td>
<td>(0,1.5]</td>
<td>(1.5,3]</td>
<td>(1.5,3]</td>
<td>(1.5,3]</td>
</tr>
<tr>
<td>Maldives</td>
<td>(1.5,3]</td>
<td></td>
<td>(3,6]</td>
<td>(3,6]</td>
</tr>
<tr>
<td>Mongolia</td>
<td>(6,12.5]</td>
<td>(12.5,25]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Namibia</td>
<td>(0,1.5]</td>
<td></td>
<td>(1.5,3]</td>
<td>(1.5,3]</td>
</tr>
<tr>
<td>Palau</td>
<td>(6,12.5]</td>
<td></td>
<td>(12.5,25]</td>
<td>(12.5,25]</td>
</tr>
<tr>
<td>Seychelles</td>
<td>(3,6]</td>
<td></td>
<td></td>
<td>(6,12.5]</td>
</tr>
<tr>
<td>Turkmenistan</td>
<td>(6,12.5]</td>
<td></td>
<td>(12.5,25]</td>
<td>(12.5,25]</td>
</tr>
<tr>
<td>Venezuela</td>
<td>(3,6]</td>
<td>(6,12.5]</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Countries that experienced a decrease in the level of carbon dioxide
emissions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> codown <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(co<span style="color:#f92672">%&gt;%</span><span style="color:#a6e22e">select</span>(Entity, Year, group)<span style="color:#f92672">%&gt;%</span><span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">2011</span>)<span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), <span style="color:#a6e22e">returndatadown</span>(co, <span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2013</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">returndatadown</span>(co, <span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2015</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">returndatadown</span>(co, <span style="color:#ae81ff">2011</span>, <span style="color:#ae81ff">2017</span>))<span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">arrange</span>(Entity)<span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(codown<span style="color:#f92672">%&gt;%</span><span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(codown<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity<span style="color:#f92672">~</span>Year))<span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>2011</th>
<th>2013</th>
<th>2015</th>
<th>2017</th>
</tr>
</thead>
<tbody>
<tr>
<td>Belize</td>
<td>(1.5,3]</td>
<td>(0,1.5]</td>
<td>(0,1.5]</td>
<td>(0,1.5]</td>
</tr>
<tr>
<td>Bulgaria</td>
<td>(6,12.5]</td>
<td>(3,6]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Cyprus</td>
<td>(6,12.5]</td>
<td>(3,6]</td>
<td>(3,6]</td>
<td></td>
</tr>
<tr>
<td>Equatorial Guinea</td>
<td>(6,12.5]</td>
<td>(3,6]</td>
<td>(3,6]</td>
<td>(3,6]</td>
</tr>
<tr>
<td>Estonia</td>
<td>(12.5,25]</td>
<td></td>
<td>(6,12.5]</td>
<td></td>
</tr>
<tr>
<td>Italy</td>
<td>(6,12.5]</td>
<td></td>
<td>(3,6]</td>
<td>(3,6]</td>
</tr>
<tr>
<td>Malta</td>
<td>(6,12.5]</td>
<td>(3,6]</td>
<td>(3,6]</td>
<td>(3,6]</td>
</tr>
<tr>
<td>North Korea</td>
<td>(1.5,3]</td>
<td>(0,1.5]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Qatar</td>
<td>(37.5,253]</td>
<td>(25,37.5]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Spain</td>
<td>(6,12.5]</td>
<td>(3,6]</td>
<td>(3,6]</td>
<td></td>
</tr>
<tr>
<td>UK</td>
<td>(6,12.5]</td>
<td></td>
<td></td>
<td>(3,6]</td>
</tr>
<tr>
<td>Ukraine</td>
<td>(6,12.5]</td>
<td></td>
<td>(3,6]</td>
<td>(3,6]</td>
</tr>
</tbody>
</table>
<h2 id="so2">SO2</h2>
<p>To see the changes onthe map the data for sulphur dioxide is created:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> map.world_joined2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(so, map.world, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#39;Entity&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;region&#39;</span> ))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">annotate_figure</span>(<span style="color:#a6e22e">ggarrange</span>(<span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1970</span>, So2, map.world_joined2, so), 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1980</span>, So2, map.world_joined2, so), 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1990</span>, So2, map.world_joined2, so), 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">2000</span>, So2, map.world_joined2, so), 
</span></span><span style="display:flex;"><span>    ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, nrow <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, common.legend <span style="color:#f92672">=</span> F),
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>   top <span style="color:#f92672">=</span> <span style="color:#a6e22e">text_grob</span>(<span style="color:#e6db74">&#34;Sulphur dioxide emissions in 1970, 1980, 1990 and 2000&#34;</span>, 
</span></span><span style="display:flex;"><span>   face <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>))
</span></span></code></pre></div><p><img src="../Changes-in-air-pollution/sogr-1.png" alt=""></p>
<p>Countries that experienced an increase in the level of sulfur dioxide
emissions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> soup <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(so <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">1970</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(so, <span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1980</span>), 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(so, <span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1990</span>),
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(so, <span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">2000</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arrange</span>(Entity) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(soup <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(soup<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity <span style="color:#f92672">~</span> Year)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>1970</th>
<th>1980</th>
<th>1990</th>
<th>2000</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azerbaijan</td>
<td>(0.017,0.034]</td>
<td></td>
<td>(0.034,0.07]</td>
<td></td>
</tr>
<tr>
<td>Bahrain</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>Benin</td>
<td>(0,0.001]</td>
<td></td>
<td></td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Bosnia and Herzegovina</td>
<td>(0.034,0.07]</td>
<td></td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Botswana</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.034,0.07]</td>
<td></td>
</tr>
<tr>
<td>Brunei</td>
<td>(0.07,0.2]</td>
<td>(0.2,0.425]</td>
<td>(0.2,0.425]</td>
<td>(0.2,0.425]</td>
</tr>
<tr>
<td>Bulgaria</td>
<td>(0.07,0.2]</td>
<td>(0.2,0.425]</td>
<td>(0.2,0.425]</td>
<td></td>
</tr>
<tr>
<td>Cameroon</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>China</td>
<td>(0.001,0.017]</td>
<td></td>
<td></td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Croatia</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td></td>
</tr>
<tr>
<td>Eritrea</td>
<td>(0,0.001]</td>
<td></td>
<td></td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Estonia</td>
<td>(0.07,0.2]</td>
<td>(0.2,0.425]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Gabon</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Greece</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Haiti</td>
<td>(0,0.001]</td>
<td></td>
<td>(0.001,0.017]</td>
<td></td>
</tr>
<tr>
<td>Iceland</td>
<td>(0.034,0.07]</td>
<td></td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>Indonesia</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Iraq</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Israel</td>
<td>(0.034,0.07]</td>
<td></td>
<td></td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>Jamaica</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Jordan</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Lebanon</td>
<td>(0.001,0.017]</td>
<td></td>
<td></td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Lithuania</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Macedonia</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Malta</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Moldova</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Mongolia</td>
<td>(0,0.001]</td>
<td></td>
<td>(0.034,0.07]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Namibia</td>
<td>(0,0.001]</td>
<td>(0.07,0.2]</td>
<td>(0.034,0.07]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Nepal</td>
<td>(0,0.001]</td>
<td></td>
<td></td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>North Korea</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td></td>
</tr>
<tr>
<td>Oman</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Panama</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Portugal</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Republic of Congo</td>
<td>(0.001,0.017]</td>
<td></td>
<td></td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Russia</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Saudi Arabia</td>
<td>(0.017,0.034]</td>
<td>(0.07,0.2]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Singapore</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>South Korea</td>
<td>(0.017,0.034]</td>
<td></td>
<td>(0.034,0.07]</td>
<td></td>
</tr>
<tr>
<td>Spain</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Syria</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Trinidad</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Tunisia</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Turkey</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Turkmenistan</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>United Arab Emirates</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Yemen</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
</tr>
</tbody>
</table>
<p>Countries that experienced a decrease in the level of sulfur dioxide
emissions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> soup <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(so <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">1970</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(so, <span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1980</span>), 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(so, <span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1990</span>),
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(so, <span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">2000</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arrange</span>(Entity) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(soup <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(soup<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity <span style="color:#f92672">~</span> Year)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>1970</th>
<th>1980</th>
<th>1990</th>
<th>2000</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azerbaijan</td>
<td>(0.017,0.034]</td>
<td></td>
<td>(0.034,0.07]</td>
<td></td>
</tr>
<tr>
<td>Bahrain</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>Benin</td>
<td>(0,0.001]</td>
<td></td>
<td></td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Bosnia and Herzegovina</td>
<td>(0.034,0.07]</td>
<td></td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Botswana</td>
<td>(0,0.001]</td>
<td></td>
<td>(0.001,0.017]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Brunei</td>
<td>(0.07,0.2]</td>
<td>(0.2,0.425]</td>
<td>(0.2,0.425]</td>
<td>(0.2,0.425]</td>
</tr>
<tr>
<td>Bulgaria</td>
<td>(0.07,0.2]</td>
<td>(0.2,0.425]</td>
<td>(0.2,0.425]</td>
<td></td>
</tr>
<tr>
<td>Cameroon</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>China</td>
<td>(0.001,0.017]</td>
<td></td>
<td></td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Croatia</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td></td>
</tr>
<tr>
<td>Eritrea</td>
<td>(0,0.001]</td>
<td></td>
<td></td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Estonia</td>
<td>(0.07,0.2]</td>
<td>(0.2,0.425]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Gabon</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Greece</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Haiti</td>
<td>(0,0.001]</td>
<td></td>
<td>(0.001,0.017]</td>
<td></td>
</tr>
<tr>
<td>Iceland</td>
<td>(0.034,0.07]</td>
<td></td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>Indonesia</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Iraq</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Israel</td>
<td>(0.034,0.07]</td>
<td></td>
<td></td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>Jamaica</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Jordan</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Lebanon</td>
<td>(0.001,0.017]</td>
<td></td>
<td></td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Lithuania</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Macedonia</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Malta</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Moldova</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Mongolia</td>
<td>(0,0.001]</td>
<td></td>
<td>(0.034,0.07]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Namibia</td>
<td>(0,0.001]</td>
<td>(0.07,0.2]</td>
<td>(0.034,0.07]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Nepal</td>
<td>(0,0.001]</td>
<td></td>
<td></td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>North Korea</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td></td>
</tr>
<tr>
<td>Oman</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Panama</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
</tr>
<tr>
<td>Portugal</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Republic of Congo</td>
<td>(0.001,0.017]</td>
<td></td>
<td></td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Russia</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Saudi Arabia</td>
<td>(0.017,0.034]</td>
<td>(0.07,0.2]</td>
<td>(0.034,0.07]</td>
<td>(0.034,0.07]</td>
</tr>
<tr>
<td>Singapore</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
</tr>
<tr>
<td>South Korea</td>
<td>(0.017,0.034]</td>
<td></td>
<td>(0.034,0.07]</td>
<td></td>
</tr>
<tr>
<td>Spain</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Syria</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Trinidad</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Tunisia</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Turkey</td>
<td>(0.001,0.017]</td>
<td></td>
<td>(0.017,0.034]</td>
<td>(0.017,0.034]</td>
</tr>
<tr>
<td>Turkmenistan</td>
<td>(0.017,0.034]</td>
<td>(0.034,0.07]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>United Arab Emirates</td>
<td>(0.034,0.07]</td>
<td>(0.07,0.2]</td>
<td>(0.07,0.2]</td>
<td></td>
</tr>
<tr>
<td>Yemen</td>
<td>(0,0.001]</td>
<td>(0.001,0.017]</td>
<td>(0.001,0.017]</td>
<td>(0.017,0.034]</td>
</tr>
</tbody>
</table>
<h2 id="pm">PM</h2>
<p>To see the changes on the map the data for particulate matter is
created:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> map.world_joined3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(pm, map.world, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#39;Entity&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;region&#39;</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">annotate_figure</span>(<span style="color:#a6e22e">ggarrange</span>(<span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2010</span>,<span style="color:#ae81ff">2010</span>, PM, map.world_joined3, pm),
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2010</span>,<span style="color:#ae81ff">2012</span>, PM, map.world_joined3, pm), 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2010</span>,<span style="color:#ae81ff">2014</span>, PM, map.world_joined3, pm),
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2010</span>,<span style="color:#ae81ff">2016</span>, PM, map.world_joined3, pm), 
</span></span><span style="display:flex;"><span>   ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, nrow <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, common.legend <span style="color:#f92672">=</span> F),
</span></span><span style="display:flex;"><span>   top <span style="color:#f92672">=</span> <span style="color:#a6e22e">text_grob</span>(<span style="color:#e6db74">&#34;Particulate matter esmissions in 2010, 2012, 2014, 2016&#34;</span>, 
</span></span><span style="display:flex;"><span>   face <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>))
</span></span></code></pre></div><p><img src="../Changes-in-air-pollution/pmgr-1.png" alt=""></p>
<p>The main changes of particulate matter concentration refer to African
countries. In the table below, the groups of chosen countries show that
the amount of the most harmful pollutant type (particulate matter) was
high and became higher in comparison with the reference year 2010.</p>
<p>Here is the list of countries which experienced changes in 2012, 2014
and 2016 (reference year is 2010), correspondingly. Countries which
experienced an increase in the level of particulate matter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> pmup <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(pm <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">2011</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(pm, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2012</span>),
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(pm, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2014</span>), 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndataup</span>(pm, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2016</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arrange</span>(Entity) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(pmup <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(pmup<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity <span style="color:#f92672">~</span> Year)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>2011</th>
<th>2012</th>
<th>2014</th>
<th>2016</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bangladesh</td>
<td>(65.4,86.1]</td>
<td></td>
<td>(86.1,204]</td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Belize</td>
<td>(12,24]</td>
<td>(24,44.7]</td>
<td>(24,44.7]</td>
<td></td>
</tr>
<tr>
<td>Benin</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Brazil</td>
<td>(3.29,12]</td>
<td></td>
<td></td>
<td>(12,24]</td>
</tr>
<tr>
<td>Burkina Faso</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Burundi</td>
<td>(24,44.7]</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Cameroon</td>
<td>(65.4,86.1]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Cape Verde</td>
<td>(24,44.7]</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Central African Republic</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Chad</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Democratic Republic of the Congo</td>
<td>(24,44.7]</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Djibouti</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Equatorial Guinea</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Eritrea</td>
<td>(24,44.7]</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Ethiopia</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Gabon</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Gambia</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Ghana</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Greece</td>
<td>(3.29,12]</td>
<td></td>
<td>(12,24]</td>
<td></td>
</tr>
<tr>
<td>Guinea</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Guinea-Bissau</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Haiti</td>
<td>(12,24]</td>
<td>(24,44.7]</td>
<td>(24,44.7]</td>
<td></td>
</tr>
<tr>
<td>Hungary</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>India</td>
<td>(44.7,65.4]</td>
<td>(65.4,86.1]</td>
<td>(65.4,86.1]</td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Lesotho</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>Liberia</td>
<td>(3.29,12]</td>
<td></td>
<td></td>
<td>(12,24]</td>
</tr>
<tr>
<td>Mali</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Mauritania</td>
<td>(65.4,86.1]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Mongolia</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>Morocco</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>Namibia</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>Nepal</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(65.4,86.1]</td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Nicaragua</td>
<td>(24,44.7]</td>
<td>(24,44.7]</td>
<td>(24,44.7]</td>
<td></td>
</tr>
<tr>
<td>Nigeria</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Oman</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Pakistan</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Panama</td>
<td>(3.29,12]</td>
<td></td>
<td>(12,24]</td>
<td>(12,24]</td>
</tr>
<tr>
<td>Papua New Guinea</td>
<td>(12,24]</td>
<td>(12,24]</td>
<td>(12,24]</td>
<td>(12,24]</td>
</tr>
<tr>
<td>Rwanda</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Senegal</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Singapore</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>South Sudan</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Sudan</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Swaziland</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>Switzerland</td>
<td>(3.29,12]</td>
<td></td>
<td>(12,24]</td>
<td></td>
</tr>
<tr>
<td>Thailand</td>
<td>(12,24]</td>
<td></td>
<td>(24,44.7]</td>
<td></td>
</tr>
<tr>
<td>Togo</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Uganda</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>UK</td>
<td>(3.29,12]</td>
<td>(12,24]</td>
<td>(12,24]</td>
<td></td>
</tr>
<tr>
<td>United Arab Emirates</td>
<td>(65.4,86.1]</td>
<td></td>
<td></td>
<td>(86.1,204]</td>
</tr>
<tr>
<td>Uzbekistan</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Venezuela</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
<tr>
<td>Yemen</td>
<td>(44.7,65.4]</td>
<td></td>
<td></td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Zimbabwe</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(24,44.7]</td>
</tr>
</tbody>
</table>
<p>Countries which experienced a decrease in the level of particulate
matter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> pmdown <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(pm <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">2011</span>) <span style="color:#f92672">%&gt;%</span>  <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">returndatadown</span>(pm, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2012</span>), 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">returndatadown</span>(pm, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2014</span>), 
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">returndatadown</span>(pm, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2016</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">arrange</span>(Entity) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(pmdown <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(pmdown<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity <span style="color:#f92672">~</span> Year)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>2011</th>
<th>2012</th>
<th>2014</th>
<th>2016</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bahrain</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(44.7,65.4]</td>
<td></td>
</tr>
<tr>
<td>Bolivia</td>
<td>(24,44.7]</td>
<td></td>
<td></td>
<td>(12,24]</td>
</tr>
<tr>
<td>Burkina Faso</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(24,44.7]</td>
<td></td>
</tr>
<tr>
<td>France</td>
<td>(12,24]</td>
<td></td>
<td></td>
<td>(3.29,12]</td>
</tr>
<tr>
<td>Iran</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(24,44.7]</td>
<td></td>
</tr>
<tr>
<td>Iraq</td>
<td>(65.4,86.1]</td>
<td>(65.4,86.1]</td>
<td>(44.7,65.4]</td>
<td>(65.4,86.1]</td>
</tr>
<tr>
<td>Japan</td>
<td>(3.29,12]</td>
<td>(3.29,12]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Kuwait</td>
<td>(86.1,204]</td>
<td></td>
<td>(65.4,86.1]</td>
<td></td>
</tr>
<tr>
<td>Libya</td>
<td>(44.7,65.4]</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(44.7,65.4]</td>
</tr>
<tr>
<td>Niger</td>
<td>(86.1,204]</td>
<td></td>
<td>(65.4,86.1]</td>
<td></td>
</tr>
<tr>
<td>Nigeria</td>
<td>(44.7,65.4]</td>
<td></td>
<td>(24,44.7]</td>
<td></td>
</tr>
<tr>
<td>Sierra Leone</td>
<td>(24,44.7]</td>
<td></td>
<td>(12,24]</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="oz">OZ</h2>
<p>To see the changes on the map the data for ozone is created:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> map.world_joined4 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(oz,map.world, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#39;Entity&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;region&#39;</span> ))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">annotate_figure</span>(<span style="color:#a6e22e">ggarrange</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2005</span>, OZ, map.world_joined4, oz),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2010</span>, OZ, map.world_joined4, oz), 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2013</span>, OZ, map.world_joined4, oz), 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">finalplot</span>(<span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2015</span>, OZ, map.world_joined4, oz), 
</span></span><span style="display:flex;"><span>   ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, nrow <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, common.legend <span style="color:#f92672">=</span> F), 
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>   top <span style="color:#f92672">=</span> <span style="color:#a6e22e">text_grob</span>(<span style="color:#e6db74">&#34;Concentration of ozone in 2005, 2010, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          2013, 2015&#34;</span>, face <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>))
</span></span></code></pre></div><p><img src="../Changes-in-air-pollution/ozgr-1.png" alt=""></p>
<p>Countries which experienced an increase in the level of ozone
concentration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> ozup <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(oz <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">2005</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">returndataup</span>(oz, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2010</span>), 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">returndataup</span>(oz, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2013</span>), 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">returndataup</span>(oz, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2015</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arrange</span>(Entity) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(ozup <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(ozup<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity <span style="color:#f92672">~</span> Year)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>2005</th>
<th>2010</th>
<th>2013</th>
<th>2015</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bangladesh</td>
<td>(56.6,67.4]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>Bhutan</td>
<td>(56.6,67.4]</td>
<td></td>
<td></td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>Bolivia</td>
<td>(45.7,56.6]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
<tr>
<td>Cambodia</td>
<td>(34.9,45.7]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
</tr>
<tr>
<td>Colombia</td>
<td>(34.9,45.7]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
</tr>
<tr>
<td>El Salvador</td>
<td>(45.7,56.6]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
<tr>
<td>Laos</td>
<td>(45.7,56.6]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
<tr>
<td>Malaysia</td>
<td>(34.9,45.7]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
</tr>
<tr>
<td>Maldives</td>
<td>(45.7,56.6]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
<tr>
<td>Myanmar</td>
<td>(67.4,78.3]</td>
<td></td>
<td></td>
<td>(78.3,116]</td>
</tr>
<tr>
<td>North Korea</td>
<td>(56.6,67.4]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>Pakistan</td>
<td>(56.6,67.4]</td>
<td></td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>Paraguay</td>
<td>(45.7,56.6]</td>
<td></td>
<td></td>
<td>(56.6,67.4]</td>
</tr>
<tr>
<td>Saudi Arabia</td>
<td>(56.6,67.4]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>South Korea</td>
<td>(56.6,67.4]</td>
<td></td>
<td></td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>Taiwan</td>
<td>(56.6,67.4]</td>
<td></td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>Thailand</td>
<td>(45.7,56.6]</td>
<td></td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
<tr>
<td>Venezuela</td>
<td>(34.9,45.7]</td>
<td></td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
</tr>
<tr>
<td>Zimbabwe</td>
<td>(45.7,56.6]</td>
<td></td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
</tbody>
</table>
<p>Countries which experienced a decrease in the level of ozone
concentration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>  ozdown <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(oz <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(Entity, Year, group) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filter</span>(Year <span style="color:#f92672">==</span> <span style="color:#ae81ff">2005</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rename</span>(group.x <span style="color:#f92672">=</span> group), 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">returndatadown</span>(oz, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2010</span>), 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">returndatadown</span>(oz, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2013</span>), 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">returndatadown</span>(oz, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2015</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arrange</span>(Entity) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rename</span>(Group <span style="color:#f92672">=</span> group.x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">dcast</span>(ozdown <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">names</span>(<span style="color:#a6e22e">which</span>(<span style="color:#a6e22e">table</span>(ozdown<span style="color:#f92672">$</span>Entity) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>))), Entity <span style="color:#f92672">~</span> Year)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>2005</th>
<th>2010</th>
<th>2013</th>
<th>2015</th>
</tr>
</thead>
<tbody>
<tr>
<td>Central African Republic</td>
<td>(78.3,116]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
<td>(67.4,78.3]</td>
</tr>
<tr>
<td>Nigeria</td>
<td>(67.4,78.3]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
<tr>
<td>Norway</td>
<td>(45.7,56.6]</td>
<td></td>
<td>(34.9,45.7]</td>
<td>(34.9,45.7]</td>
</tr>
<tr>
<td>Portugal</td>
<td>(56.6,67.4]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
<td>(45.7,56.6]</td>
</tr>
<tr>
<td>USA</td>
<td>(67.4,78.3]</td>
<td></td>
<td>(56.6,67.4]</td>
<td>(56.6,67.4]</td>
</tr>
</tbody>
</table>
<h2 id="conclusion">Conclusion</h2>
<p>Apart from affecting our health, a decrease in the level of air quality
is causing long-term environmental damage by driving climate change,
which is itself a danger for people and their health. Thus the air
pollution level should be well monitored by countries, analyzed and the
appropriate action should be taken into consideration.</p>
<p>The analysis of the data shows that in both high-income countries with
well-developed air quality monitoring networks and low- and
middle-income countries with poor data coverage, the condition of
outdoor air pollution becomes worse. To sum up, by considering certain
reference year for each pollution type, we can point out the following
facts:</p>
<ul>
<li>CO2 (Reference year is 2011)</li>
</ul>
<p>In recent years, the changes in carbon dioxide emissions are not sharp.
For example, in 2013, 3% of counties experienced an increase and 4% of
them experienced a decrease in the level of carbon dioxide emissions.
Similarly, in 2015, 5% of countries and 4% of countries; in 2017, 5% and
3% of countries experienced an increase and a decrease correspondingly
in the level of carbon dioxide emissions.</p>
<ul>
<li>SO2 (Reference year is 1970)</li>
</ul>
<p>In 1980, 22% of counties experienced an increase and 9% of them
experienced a decrease in the level of sulphur dioxide emissions.
Similarly, in 1990, 25% of countries and 22% of countries; in 2000, 22%
and 35% of countries experienced an increase and a decrease
correspondingly in the level of sulphur dioxide emissions.</p>
<ul>
<li>PM (Reference year is 2010)</li>
</ul>
<p>In 2012, 7% and 2% of countries show the increase and decrease in the
amount of particulate matter in the air, accordingly. In 2014, 8% and 4%
of countries show the increase and decrease in the amount of particulate
matter in the air, accordingly. In 2016, 25% and 2% of countries show
the increase and decrease in the amount of particulate matter in the
air, accordingly.</p>
<ul>
<li>OZ (Reference year is 2005)</li>
</ul>
<p>In 2010, 5% and 2% of countries show an increase and decrease in the
level of ozone concentration in the air, accordingly. In 2013, 8% and 3%
of countries show an increase and decrease in the level of ozone
concentration in the air, accordingly. In 2015, 10% and 3% of countries
show an increase and decrease in the level of ozone concentration in the
air, accordingly.</p>

                
            </div>
        </div>
            
            
                <div class="card-footer text-muted">
                   
                
                <div class="blog-tags">
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/data-analysis/">Data Analysis</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/air-quality-monitoring/">Air Quality Monitoring</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/environmental-science/">Environmental Science</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/outlier-detection/">Outlier Detection</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/ozone-concentration/">Ozone Concentration</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/carbon-dioxide-emissions/">Carbon Dioxide Emissions</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/health-risks/">Health Risks</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/climate-change/">Climate Change</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/sulphur-dioxide-emissions/">Sulphur Dioxide Emissions</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/lung-cancer/">Lung Cancer</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/who/">WHO</a>
                  
                </div>
                
              </div>


 
    </div>
</div>
    
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">
    <div class="card mb-3 ">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <h3 class="post-title">Outlier Detection in Air Pollution Data</h3>
                </div>
                <div class="col-md-2 d-flex justify-content-end">
                    <a href="https://DatamotusBlog.netlify.app/notes/2020/2019-11-15-outlier-detection/">
                    <button type="button" class="btn btn-outline-dark">
                        Link
                    </button>
                </a>
                </div>
            </div>

            

            <p class="post-meta">
                <span class="post-meta text-muted">
  
  

  November 15, 2019

  

  

  

  
</span>
            </p>
            
            <div class="post-entry">

                
                <p><img src="../Outlier-Detection/website4.jpeg" alt="image"></p>
<h1 id="introduction">Introduction</h1>
<p>On a daily basis, economical, technological and political changes cause
air pollution, which is currently one of the most pressing environmental
issues around the globe. It is particularly acute in large cities with
the rising level of industrialization and growing urbanization. The
polluted air we breathe results in serious health disorders and
decreases the quality of life. Before steps are taken to decrease the
harmful effect of daily produced pollutants, certain measurements are
required.</p>
<p>Government agencies use <strong>air quality index</strong> to communicate with the
public. An example of such communication is recommendations to reduce or
avoid outdoor physical exertion when the air quality index (AQI) is too
high. Different countries have their own air quality indices and they
use their own method of calculation and health risk categories.
Typically, outdoor<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> air pollution can be defined as the emission of
harmful substances into the atmosphere. This broad definition
encapsulates a number of pollutants, including:</p>
<ul>
<li>sulphur dioxide ($SO_2$),</li>
<li>nitrogen oxides ($NO_x$),</li>
<li>ozone ($O_3$),</li>
<li>particulate matter,</li>
<li>carbon monoxide ($CO$)</li>
<li>carbon dioxide ($CO_2$)</li>
<li>and volatile organic compounds ($VOC_s$).</li>
</ul>
<p>We took the historical data of annual emissions of carbon dioxide per
person, based on territorial emissions derived by <a href="https://ourworldindata.org/co2-and-other-greenhouse-gas-emissions">Our World in
Data</a>.
Per capita emissions (production-based) were calculated dividing the
total national $CO_2$ emissions per year by population estimates. The
summary of the dataset is presented below. The number of observations in
the initial data is 42,844 and the range of variable time span is 1751
&ndash; 2017. For the further analysis the observation before 1970 that have
value of zero are omitted. The dataset used in this analysis can be
found
<a href="../Outlier-Detection/co-emissions-per-capita.csv">here</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#75715e"># load the required libraries used in the article</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">if </span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;pacman&#34;</span>)) <span style="color:#a6e22e">install.packages</span>(<span style="color:#e6db74">&#34;pacman&#34;</span>)
</span></span><span style="display:flex;"><span> pacman<span style="color:#f92672">::</span><span style="color:#a6e22e">p_load</span>(ggplot2, dplyr, kableExtra, tsoutliers, forecast, TSA)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> co <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;co-emissions-per-capita.csv&#34;</span>)
</span></span><span style="display:flex;"><span> cond <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">which</span>(co<span style="color:#f92672">$</span>Year <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1970</span> <span style="color:#f92672">&amp;</span> co<span style="color:#f92672">$</span>Co2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span> co <span style="color:#f92672">&lt;-</span> co[<span style="color:#f92672">-</span>cond,]
</span></span></code></pre></div><p>We can look at the summary of the dataframe.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">options</span>(knitr.kable.NA <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">summary</span>(co), digits<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Entity</th>
<th>Code</th>
<th>Year</th>
</tr>
</thead>
<tbody>
<tr>
<td>Canada : 218</td>
<td>CAN : 218</td>
<td>Min. :1751</td>
</tr>
<tr>
<td>Germany : 218</td>
<td>DEU : 218</td>
<td>1st Qu.:1948</td>
</tr>
<tr>
<td>Poland : 218</td>
<td>GBR : 218</td>
<td>Median :1975</td>
</tr>
<tr>
<td>United Kingdom: 218</td>
<td>POL : 218</td>
<td>Mean :1965</td>
</tr>
<tr>
<td>United States : 218</td>
<td>USA : 218</td>
<td>3rd Qu.:1996</td>
</tr>
<tr>
<td>France : 210</td>
<td>FRA : 210</td>
<td>Max. :2017</td>
</tr>
<tr>
<td>(Other) :15560</td>
<td>(Other):15560</td>
<td></td>
</tr>
</tbody>
</table>
<p>The variables <code>Entity</code> and <code>Code</code> show the country and/ or area and its
code, where the level of carbon dioxide was measured. The variables
<code>Year</code> and <code>Co2</code> show the time span of variable <code>Co2</code> and the carbon
dioxide measured in tones ($CO_2$ data has been converted from tones of
carbon to tones of carbon dioxide ($CO_2$) using a conversion factor of
3.664).</p>
<p>We will now explore the pattern of $CO_2$ by looking at the data of 3
particular countries: Venezuela, United Arab Emirates, and the Bahamas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> co <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(Entity <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Venezuela&#34;</span>, <span style="color:#e6db74">&#34;United Arab Emirates&#34;</span>, <span style="color:#e6db74">&#34;Bahamas&#34;</span>)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">geom_line</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> Year, y <span style="color:#f92672">=</span> Co2, color <span style="color:#f92672">=</span> Entity)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">theme</span>(legend.position<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">facet_grid</span>(.~Entity, scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fixed&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">ggtitle</span>(<span style="color:#e6db74">&#34;The emissions of CO2 per capita&#34;</span>)
</span></span></code></pre></div><p><img src="../Outlier-Detection/selected-1.png" alt=""></p>
<p>These countries were not selected randomly. If you look at the time
series of these countries separately, the different types of outliers:
<strong>additive, innovational</strong>, and <strong>level shift outliers</strong> can be found in
the time series of $CO_2$ in Venezuela, the United Arab Emirates and the
Bahamas correspondingly. Outliers are usually the unexpected spikes or
dips of observations at given points in time.</p>
<h1 id="outliers-and-detection">Outliers and detection</h1>
<p>Time series observations reveal frequent shifts in the data. The shifts
in a time series that cannot be explained are referred to as
<strong>outliers</strong>. One important reason to detect outliers is that they can
represent an error. At the same time, these observations are
inconsistent with the rest of the series and can dramatically influence
the analysis, thus affecting the forecasting capacity of the time series
model. So, to increase the prediction accuracy they must be removed
before the analysis. Here are the most common types of outliers:</p>
<ul>
<li>Additive Outliers</li>
<li>Level Shifts</li>
<li>Transient Change</li>
<li>Innovation Outliers</li>
<li>Seasonal Level Shifts</li>
</ul>
<p>Three of the aforementioned outliers are to be considered below. There
are different tools and methods to detect and deal with outliers (time
series decomposition, generalized extreme student deviation, ARIMA,
etc.). In order to detect the presence of outliers in the time series we
will use the R function <code>tso()</code> , an interface to the automatic
detection procedure provided in the package
<a href="https://cran.r-project.org/web/packages/tsoutliers/tsoutliers.pdf">tsoutliers</a>.
The R package <code>tsoutliers</code> implements the <strong>Chen and Liu</strong> procedure for
the detection of outliers in time series. Different types of outliers
(by default: <strong>AO</strong> additive outliers; <strong>LS</strong> level shifts, <strong>IO</strong>
innovative outliers, etc.) can be selected in the function. The proposed
procedure may be applied both to general seasonal and nonseasonal ARMA
processes.</p>
<h2 id="additive-outliers">Additive Outliers</h2>
<p>An <strong>additive outlier</strong> (<em>AO</em>) corresponds to an exogenous change of a
<strong>single observation</strong> of the time series. Subsequent observations are
unaffected by an additive outlier. Due to external causes, this type of
outlier is usually associated with <strong>isolated</strong> incidents like
measurement errors or impulse effects.</p>
<p>The graph indicates that the time series of the following countries can
have an additive outlier/outliers:</p>
<ul>
<li>Brunei</li>
<li>Mauritania</li>
<li>Togo</li>
<li>The United Kingdom</li>
<li>Venezuela</li>
<li>Yemen</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> AO <span style="color:#f92672">&lt;-</span> co[co<span style="color:#f92672">$</span>Entity <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Brunei&#34;</span>, <span style="color:#e6db74">&#34;Mauritania&#34;</span>, <span style="color:#e6db74">&#34;Togo&#34;</span>, <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Venezuela&#34;</span>, <span style="color:#e6db74">&#34;Yemen&#34;</span>), ]
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> AO) <span style="color:#f92672">+</span> <span style="color:#a6e22e">geom_line</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> Year, y <span style="color:#f92672">=</span> Co2, color <span style="color:#f92672">=</span> Entity)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">theme</span>(legend.position<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>Entity, scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">ggtitle</span>(<span style="color:#e6db74">&#34;The emissions of CO2 per capita&#34;</span>)
</span></span></code></pre></div><p><img src="../Outlier-Detection/ao-1.png" alt=""></p>
<p>We will now consider the time series of Venezuela and United Kingdom.
The plot above shows that the value of the year 1946 (17 tonnes of
carbon dioxide) in Venezuela is not typical for the data. To check this
assumption the <code>tso</code> function can be used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> tsoutliers<span style="color:#f92672">::</span><span style="color:#a6e22e">tso</span>(<span style="color:#a6e22e">ts</span>(AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Venezuela&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Venezuela&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]), types <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;AO&#34;</span>)
</span></span></code></pre></div><pre><code>## Series: ts(AO[AO$Entity == &quot;Venezuela&quot;, &quot;Co2&quot;], start = AO[AO$Entity ==  &quot;Venezuela&quot;, &quot;Year&quot;][1]) 
## Regression with ARIMA(0,1,0) errors 
## 
## Coefficients:
##          AO34
##       13.1953
## s.e.   0.4437
## 
## sigma^2 estimated as 0.3976:  log likelihood=-99.11
## AIC=202.21   AICc=202.33   BIC=207.5
## 
## Outliers:
##   type ind time coefhat tstat
## 1   AO  34 1937    13.2 29.74
</code></pre>
<p>We will now study the value of CO2 in Venezuela tested as an outlier
(with the index of 34).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Venezuela&#34;</span>,][34,]
</span></span></code></pre></div><pre><code>## Entity Code Year Co2
## 41780 Venezuela  VEN 1946 17.03064
</code></pre>
<p>The procedure first detects outliers upon a chosen ARIMA model (which is
an iterative process), then it chooses the ARIMA model including the
outliers detected in the previous step and removes the outliers that are
not significant in the new fit. The procedure is repeated until no
outliers are detected or until a maximum number of iterations (by
default, 4) is reached (Chen and Liu, 2013). There is yet another <code>TSA</code>
function that can be used to check the existence of additive outliers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">detectAO</span>(<span style="color:#a6e22e">arima</span>(<span style="color:#a6e22e">ts</span>(AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Venezuela&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>]), 
</span></span><span style="display:flex;"><span>   order <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)), alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>, robust <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) 
</span></span></code></pre></div><pre><code>##              [,1]
## ind     34.000000
## lambda2  4.238379
</code></pre>
<p>The time series of Brunei also detects an outlier between the years of
1947 and 1949. These, however, are not the only types of outliers data
can have. For example, the value of 1970 can be considered a level shift
outlier. Different types of outliers can be simultaneously checked using
the vector of possible types in the <code>tso()</code> function. Although, Chung
and Liu (2013) state that, from a computational standpoint, the strategy
of detecting outliers one by one may be the only feasible approach to
dealing with multiple outliers, it seems more appropriate to estimate
the outlier effects jointly rather than sequentially. Besides, a
procedure based solely on iteratively adjusted residuals may often
result in biased estimates for adjacent outliers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> tsoutliers<span style="color:#f92672">::</span><span style="color:#a6e22e">tso</span>(<span style="color:#a6e22e">ts</span>(AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]), types <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;AO&#34;</span>,<span style="color:#e6db74">&#34;LS&#34;</span>, <span style="color:#e6db74">&#34;IO&#34;</span>)) 
</span></span></code></pre></div><pre><code>## Series: ts(AO[AO$Entity == &quot;United Kingdom&quot;, &quot;Co2&quot;], start = AO[AO$Entity ==  &quot;United Kingdom&quot;, &quot;Year&quot;][1]) 
## Regression with ARIMA(1,2,2) errors 
## 
## Coefficients:
##          ar1      ma1     ma2     AO94    IO122    AO127
##       0.5189  -1.7097  0.7403  -1.2028  -0.1929  -4.6164
## s.e.  0.1783   0.1424  0.1436   0.3247   0.1766   0.3261
## 
## sigma^2 estimated as 0.181:  log likelihood=-120.34
## AIC=254.68   AICc=255.22   BIC=278.31
## 
## Outliers:
##   type ind time coefhat   tstat
## 1   AO  94 1893 -1.2028  -3.704
## 2   IO 122 1921 -0.1929  -1.092
## 3   AO 127 1926 -4.6164 -14.155
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, ]<span style="color:#a6e22e">[c</span>(<span style="color:#ae81ff">94</span>,<span style="color:#ae81ff">122</span>,<span style="color:#ae81ff">127</span>),]
</span></span></code></pre></div><pre><code>##               Entity Code Year      Co2
## 40421 United Kingdom  GBR 1893 8.958951
## 40449 United Kingdom  GBR 1921 7.245594
## 40454 United Kingdom  GBR 1926 5.437124
</code></pre>
<p>As assumed, the levels of $CO_2$ in the year of 1893 and 1926 are
treated as outliers. In addition, the algorithm found innovational
outlier (see details about this type of outlier below) in the year 1921.</p>
<p>In forecasting models, removing outliers may be highly dangerous. If the
forecasting models are sensitive to outliers, we need to replace them,
because outliers will skew the coefficients. To deal with additive
outliers, the <code>tsoutliers()</code> function from the package <code>forecast</code>,
designed to identify and to suggest potential replacement values, can be
used. In our data of the United Kingdom there are three outliers and,
correspondingly, three replacements:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">tsoutliers</span>(<span style="color:#a6e22e">ts</span>(AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>],
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]))
</span></span></code></pre></div><pre><code>## $index
## [1]  94 122 127
## 
## $replacements
## [1] 10.12905 10.18127 10.10963
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> replUnKing <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ts</span>(AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1])
</span></span><span style="display:flex;"><span> replUnKing<span style="color:#a6e22e">[c</span>(<span style="color:#ae81ff">94</span>, <span style="color:#ae81ff">122</span>, <span style="color:#ae81ff">127</span>)] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">10.12905</span>, <span style="color:#ae81ff">10.18127</span>, <span style="color:#ae81ff">10.10963</span>)
</span></span></code></pre></div><p>An alternative useful function identifying and replacing outliers is
<code>tsclean()</code> from the same package. In this case, linear interpolation is
used to estimate missing values and to replace outliers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> replUnKing <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tsclean</span>(<span style="color:#a6e22e">ts</span>(AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> out <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(
</span></span><span style="display:flex;"><span>   UK <span style="color:#f92672">=</span> <span style="color:#a6e22e">ts</span>(AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>     start <span style="color:#f92672">=</span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]),
</span></span><span style="display:flex;"><span>   replUnKing, Year <span style="color:#f92672">=</span> AO[AO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> out) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">geom_line</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> Year, y <span style="color:#f92672">=</span> UK, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#FC4E07&#34;</span>), size <span style="color:#f92672">=</span><span style="color:#ae81ff">1.1</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">geom_line</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> Year, y <span style="color:#f92672">=</span> replUnKing, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#E7B800&#34;</span>)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">scale_color_discrete</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span>, labels <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Replaced&#34;</span>, <span style="color:#e6db74">&#34;UK CO2&#34;</span>))<span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">labs</span>(y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CO2&#34;</span>, title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Replacing the outliers&#34;</span>)
</span></span></code></pre></div><p><img src="../Outlier-Detection/replacement-1.png" alt=""></p>
<h2 id="innovational-outliers">Innovational Outliers</h2>
<p><strong>Innovational Outlier</strong> or Intervention Outlier (<em>IO</em>) corresponds to
an endogenous change of a single innovation of the time series and is
usually associated with isolated incidents such as an impulse. The
influence of the outliers may increase over time. It represents a shock.</p>
<p>The following countries are selected to visually study the case of
having innovational outlier/outliers:</p>
<ul>
<li>Cape Verde</li>
<li>Iran</li>
<li>Germany</li>
<li>Armenia</li>
<li>The United Arab Emirates</li>
<li>Mauritania</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> IO <span style="color:#f92672">&lt;-</span> co[co<span style="color:#f92672">$</span>Entity <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Cape Verde&#34;</span>, <span style="color:#e6db74">&#34;Iran&#34;</span>, <span style="color:#e6db74">&#34;Germany&#34;</span>, <span style="color:#e6db74">&#34;Armenia&#34;</span>, 
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">&#34;United Arab Emirates&#34;</span>, <span style="color:#e6db74">&#34;Mauritania&#34;</span>), ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> IO) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">geom_line</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> Year, y <span style="color:#f92672">=</span> Co2, color <span style="color:#f92672">=</span> Entity)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">theme</span>(legend.position<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>Entity,scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">ggtitle</span>(<span style="color:#e6db74">&#34;The emissions of CO2 per capita&#34;</span>)
</span></span></code></pre></div><p><img src="../Outlier-Detection/io-1.png" alt=""></p>
<p>The time series for the United Arab Emirates shows innovational outliers
in 1969 and 1998, which are to be tested:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> tsoutliers<span style="color:#f92672">::</span><span style="color:#a6e22e">tso</span>(<span style="color:#a6e22e">ts</span>(IO[IO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Arab Emirates&#34;</span>,<span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> IO[IO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Arab Emirates&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]),types <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;LS&#34;</span>,<span style="color:#e6db74">&#34;IO&#34;</span>)) 
</span></span></code></pre></div><pre><code>## Series: ts(IO[IO$Entity == &quot;United Arab Emirates&quot;, &quot;Co2&quot;], start = IO[IO$Entity == &quot;United Arab Emirates&quot;, &quot;Year&quot;][1]) 
## Regression with ARIMA(2,0,0) errors 
## 
## Coefficients:
##          ar1      ar2     IO11    LS26    IO40
##       1.3633  -0.4085  66.2302  9.0712  9.2042
## s.e.  0.1161   0.1162   3.6876  6.0046  3.6875
## 
## sigma^2 estimated as 44.8:  log likelihood=-194.83
## AIC=401.67   AICc=403.29   BIC=414.13
## 
## Outliers:
##   type ind time coefhat  tstat
## 1   IO  11 1969  66.230 17.960
## 2   LS  26 1984   9.071  1.511
## 3   IO  40 1998   9.204  2.496
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> IO[IO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Arab Emirates&#34;</span>,]<span style="color:#a6e22e">[c</span>(<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">40</span>),]
</span></span></code></pre></div><pre><code>##                     Entity Code Year       Co2
## 40279 United Arab Emirates  ARE 1969 100.61529
## 40308 United Arab Emirates  ARE 1998  28.42788
</code></pre>
<p>The algorithm detected a level shift outlier in the year 1984 (see
details below).</p>
<p>Armenia&rsquo;s level of $CO_2$ has an innovational outlier in 1993. It can
also be seen through the function <code>detectIO()</code> and can be visually
studied in the graph above.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> tsoutliers<span style="color:#f92672">::</span><span style="color:#a6e22e">tso</span>(<span style="color:#a6e22e">ts</span>(IO[IO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Armenia&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>],
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> IO[IO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Armenia&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]),types <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;IO&#34;</span>, <span style="color:#e6db74">&#34;AO&#34;</span>)) 
</span></span></code></pre></div><pre><code>## Series: ts(IO[IO$Entity == &quot;Armenia&quot;, &quot;Co2&quot;], start = IO[IO$Entity == &quot;Armenia&quot;, &quot;Year&quot;][1]) 
## Regression with ARIMA(0,1,0) errors 
## 
## Coefficients:
##          IO35
##       -0.9156
## s.e.   0.1209
## 
## sigma^2 estimated as 0.01488:  log likelihood=40.23
## AIC=-76.45   AICc=-76.24   BIC=-72.33
## 
## Outliers:
##   type ind time coefhat  tstat
## 1   IO  35 1993 -0.9156 -7.571
</code></pre>
<p>The number 35 is tagged as an innovative outlier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> IO[IO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Armenia&#34;</span>,][35,]
</span></span></code></pre></div><pre><code>##       Entity Code Year       Co2
## 1720 Armenia  ARM 1993 0.7458196
</code></pre>
<p>Detect innovative outlier with detectIO().</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> <span style="color:#a6e22e">detectIO</span>(<span style="color:#a6e22e">arima</span>(<span style="color:#a6e22e">ts</span>(IO[IO<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Armenia&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>]), 
</span></span><span style="display:flex;"><span>   order <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>)), alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>, robust <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) 
</span></span></code></pre></div><pre><code>##             [,1]      [,2]
## ind     35.00000 51.000000
## lambda1 -7.49181 -3.348504
</code></pre>
<h2 id="level-shift-outliers">Level Shift Outliers</h2>
<p><strong>Level Shift Outlier</strong> (<em>LS</em>) represents an abrupt change in the mean
level and may or may not be seasonal (Seasonal Level Shift). LS is a
change in the mean level of the time series starting at some point and
continuing until the end of the observed period. In contrast to additive
outliers, a level shift outlier affects <strong>many observations</strong> and has a
<strong>permanent</strong> effect. It can be modelled in terms of step function with
the magnitude equal to the omega parameter.</p>
<p>The countries below are selected to visually study the case of having
level shift outlier/outliers:</p>
<ul>
<li>Iceland</li>
<li>North Korea</li>
<li>Yemen</li>
<li>Bahamas</li>
<li>Lithuania</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> LS <span style="color:#f92672">&lt;-</span> co[co<span style="color:#f92672">$</span>Entity <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Iceland&#34;</span>, <span style="color:#e6db74">&#34;North Korea&#34;</span>, <span style="color:#e6db74">&#34;Yemen&#34;</span>, <span style="color:#e6db74">&#34;Bahamas&#34;</span>, <span style="color:#e6db74">&#34;Lithuania&#34;</span>), ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> LS) <span style="color:#f92672">+</span> <span style="color:#a6e22e">geom_line</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> Year, y <span style="color:#f92672">=</span> Co2, color <span style="color:#f92672">=</span> Entity)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">theme</span>(legend.position<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>Entity,scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">ggtitle</span>(<span style="color:#e6db74">&#34;The emissions of CO2 per capita&#34;</span>)
</span></span></code></pre></div><p><img src="../Outlier-Detection/ls-1.png" alt=""></p>
<p>A similar analysis for the level shift outlier was conducted for the
time series of Iceland and Bahamas. The results are presented below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> tsoutliers<span style="color:#f92672">::</span><span style="color:#a6e22e">tso</span>(<span style="color:#a6e22e">ts</span>(LS[LS<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Iceland&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> LS[LS<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Iceland&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]), types <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;LS&#34;</span>, <span style="color:#e6db74">&#34;AO&#34;</span>))
</span></span></code></pre></div><pre><code>## Series: ts(LS[LS$Entity == &quot;Iceland&quot;, &quot;Co2&quot;], start = LS[LS$Entity == &quot;Iceland&quot;, &quot;Year&quot;][1]) 
## Regression with ARIMA(0,1,0) errors 
## 
## Coefficients:
##         LS12
##       5.1622
## s.e.  0.5347
## 
## sigma^2 estimated as 0.2897:  log likelihood=-61.85
## AIC=127.7   AICc=127.86   BIC=132.41
## 
## Outliers:
##   type ind time coefhat tstat
## 1   LS  12 1947   5.162 9.654
</code></pre>
<p>As can be seen from the output above, case number 12 is tagged as an
outlier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> LS[LS<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Iceland&#34;</span>,][12,]
</span></span></code></pre></div><pre><code>##        Entity Code Year      Co2
## 16501 Iceland  ISL 1950 5.188092
</code></pre>
<p>And for Bahamas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> tsoutliers<span style="color:#f92672">::</span><span style="color:#a6e22e">tso</span>(<span style="color:#a6e22e">ts</span>(LS[LS<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Bahamas&#34;</span>, <span style="color:#e6db74">&#34;Co2&#34;</span>], 
</span></span><span style="display:flex;"><span>   start <span style="color:#f92672">=</span> LS[LS<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Bahamas&#34;</span>, <span style="color:#e6db74">&#34;Year&#34;</span>][1]),types <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;LS&#34;</span>) 
</span></span></code></pre></div><pre><code>## Series: ts(LS[LS$Entity == &quot;Bahamas&quot;, &quot;Co2&quot;], start = LS[LS$Entity ==&quot;Bahamas&quot;, &quot;Year&quot;][1]) 
## Regression with ARIMA(3,0,0) errors 
## 
## Coefficients:
##          ar1    ar2     ar3     LS22      LS32
##       0.1292  0.525  0.2965  26.6765  -23.6281
## s.e.  0.1150  0.097  0.1150   1.9063    1.8062
## 
## sigma^2 estimated as 6.589:  log likelihood=-159.16
## AIC=330.33   AICc=331.71   BIC=343.65
## 
## Outliers:
##   type ind time coefhat  tstat
## 1   LS  22 1971   26.68  13.99
## 2   LS  32 1981  -23.63 -13.08
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> LS[LS<span style="color:#f92672">$</span>Entity <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Bahamas&#34;</span>,]<span style="color:#a6e22e">[c</span>(<span style="color:#ae81ff">22</span>,<span style="color:#ae81ff">32</span>),]
</span></span></code></pre></div><pre><code>##       Entity Code Year      Co2
## 2570 Bahamas  BHS 1971 38.67267
## 2580 Bahamas  BHS 1981 12.99207
</code></pre>
<p>A dummy variable can be used to account for level shift outliers and
innovative outliers in the data. Rather than omitting the outlier, a
dummy variable removes its effect. In the case of one outlier, the dummy
variable takes value 1 for the observations before the outliers occur
and 0 for other observations. For two and more outliers coding with
several dummy variables can be implemented.</p>
<h1 id="conclusions">Conclusions</h1>
<p>In the article, we considered three types of outliers (AO, IO, and LS)
in time series modeling. Here is the summary of these types of outliers:</p>
<ul>
<li>An Additive Outlier (AO) represents an isolated spike.</li>
<li>A Level Shift (LS) represents an abrupt change in the mean level.</li>
<li>An Innovational Outlier (IO) represents a shock.</li>
</ul>
<p>To illustrate, we described the time series of annual emissions of
carbon dioxide per person to detect these outliers. The iterative
procedure of finding an outlier from the package <code>tsoutliers</code> was used.
The next step in outlier analysis should be their adjustment.</p>
<h1 id="reference-list">Reference list</h1>
<blockquote>
<p>Chen, C. and Liu, L. (2013) &lsquo;Joint Estimation of Model Parameters and
Outlier Effects in Time Series Joint Estimation of Model Parameters
and Outlier Effects in Time Series&rsquo;, 88(421), pp. 284&ndash;297.</p>
</blockquote>
<blockquote>
<p>Ahmar, A. et al. (2018) &lsquo;Modeling Data Containing Outliers using ARIMA
Additive Outlier (ARIMA-AO) Modeling Data Containing Outliers using
ARIMA Additive Outlier (ARIMA-AO)&rsquo;, Journal of Physics Conference
Series, 954. doi: 10.1088/1742-6596/954/1/012010.</p>
</blockquote>
<blockquote>
<p>Ruey S. Tsay (1988) &ldquo;Outliers, level shifts, and variance changes in
time series&rdquo;, Journal of Forecasting, 7, pp. 1-20.</p>
</blockquote>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>We focused on outdoor pollution, however air pollution occurs in
<a href="https://ourworldindata.org/indoor-air-pollution">indoor</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

                
            </div>
        </div>
            
            
                <div class="card-footer text-muted">
                   
                
                <div class="blog-tags">
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/data-analysis/">Data Analysis</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/air-quality-monitoring/">Air Quality Monitoring</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/environmental-science/">Environmental Science</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/outlier-detection/">Outlier Detection</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/time-series-analysis/">Time Series Analysis</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/urbanization/">Urbanization</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/health-risks/">Health Risks</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/climate-change/">Climate Change</a>
                  
                </div>
                
              </div>


 
    </div>
</div>
    
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">
    <div class="card mb-3 ">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <h3 class="post-title">Propensity Score Matching</h3>
                </div>
                <div class="col-md-2 d-flex justify-content-end">
                    <a href="https://DatamotusBlog.netlify.app/notes/2020/2019-10-15-propensity-score-matching/">
                    <button type="button" class="btn btn-outline-dark">
                        Link
                    </button>
                </a>
                </div>
            </div>

            

            <p class="post-meta">
                <span class="post-meta text-muted">
  
  

  November 15, 2019

  

  

  

  
</span>
            </p>
            
            <div class="post-entry">

                
                <p><img src="../Propensity-Score-Matching/website3.jpeg" alt="image"></p>
<h1 id="introduction">Introduction</h1>
<p>The research question is whether playing chess is correlated with the
improvement in logical thinking. Previous research, conducted in a
number of countries , indicates that playing a game of chess increases
concentration, logical and critical thinking, as well as the ability to
plan and analyse.</p>
<p>Should one aim at increasing the level of logical thinking among
university students and schoolchildren by playing chess, the following
steps are to be taken. Once the population, sampling method, sample size
and other crucial elements of research are defined, the sample should be
taught how to play a game of chess This may be reached by including a
relevant curriculum into the syllabus[1]. The second step to take would
be to conduct pre- and post-tests to measure the performance before and
after a six-month course. Finally, the analyses of the data would
indicate whether the experiment had a significant effect and whether the
project is worth replicating.</p>
<p>Assuming all the mentioned steps were adhered to and the evaluation of
the effectiveness of the program for university and school students has
been launched, let us review the artificially generated !
<a href="../Propensity-Score-Matching/Chess.csv">data</a>. The
summary of the dataset is presented below.</p>
<p><img src="../Propensity-Score-Matching/table1.png" alt="Alt text"></p>
<p>We have 7 variables and 921 observations without any missing values. The
variable <code>Treatment.Type</code> shows the group (Control or Treatment) to
which students were randomly assigned. The variables <code>Pre</code> and <code>Post</code>
show the number of correct answers out of 40 logical questions. Last 4
variables are the characteristics of the students: the gender, age, math
grade of a student for the last semester, and overall grade by the end
of the semester.</p>
<p>The group, used for baseline measures, is called Control group, and the
group that receives an experimental procedure is
<a href="https://www.statisticshowto.datasciencecentral.com/experimental-group/">Treatment</a>.
To estimate the effect of teaching how to play chess (<em>“treatment
effect”</em>) we can use the linear regression model that compares the
change in averages of students’ logical scores (outcome variable)
between Pre and Post surveys across the control and treatment groups
(dummy independent variables). This regression model is known as the
difference in difference
<a href="https://en.wikipedia.org/wiki/Difference_in_differences">(DiD)</a>
analysis. Before conducting regression analysis let us observe the
visual display of the treatment effect:</p>
<p><img src="../Propensity-Score-Matching/unnamed-chunk-4-1.png" alt=""></p>
<p>It is clear that unlike the pre-test results <em>after</em> the teaching
program students from the treatment group tend to answer most of the
questions correctly. In the absence of the treatment the true effect of
time shows that there is no noticeable difference between the number of
correct answers at Pre- and Post-test.</p>
<blockquote>
<p>DiD</p>
</blockquote>
<p>The result of linear regression is in the output below:</p>
<pre><code>## 
## DID Results
## ===========================================================
##                                     Dependent variable:    
##                                 ---------------------------
##                                           Answers          
## -----------------------------------------------------------
## Group (Treatment)                          0.258           
##                                           (0.343)          
##                                                            
## Time (Post)                              -0.648**          
##                                           (0.306)          
##                                                            
## Group * Time (Treatment * Post)          12.602***         
##                                           (0.485)          
##                                                            
## Constant                                 12.480***         
##                                           (0.217)          
##                                                            
## -----------------------------------------------------------
## Observations                               1,842           
## R2                                         0.487           
## Adjusted R2                                0.486           
## Residual Std. Error                  5.097 (df = 1838)     
## F Statistic                      581.677*** (df = 3; 1838) 
## ===========================================================
## Note:                           *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01
</code></pre>
<p><!-- raw HTML omitted --> The coefficient of <code>Group * Time (Treatment * Post)</code> itself is the
difference in differences estimator which tells us whether the expected
mean changes in the outcome from pre to post are different in the two
groups. At post-test, the students in the treatment group had on average
12.6 correct answers more than those from the control group. Regression
analysis shows that the effect of treatment is high and significant.</p>
<p>Is this a reliable result or are there any other factors that have not
been considered? Provided that this is an introduction to a lengthy
article (see the scrollbar), the more probable answer is “yes, we have
omitted something”. Let us discuss briefly the concepts of
<a href="https://en.wikipedia.org/wiki/Confounding">confounding</a> variable or
confounding factor and the ways in which it can be eliminated.</p>
<hr>
<h1 id="the-problem">The problem</h1>
<h2 id="confounding-bias-and-randomization-test">Confounding bias and Randomization test</h2>
<p><img src="../Propensity-Score-Matching/PsmConfounding.png" alt=""></p>
<p>The association treated by the regression analysis above can be spurious
because there may be other factors affecting both the independent
variable (treatment) and dependent variable (correct answers). Let us
consider the illustration above: <code>Z</code> is a confounding factor, we have
not accounted for, which influences both dependent (<code>Y</code>) and independent
variables (<code>X</code>), creating the correlation between the last two
variables. In this case, any baseline personal characteristic, unevenly
distributed to the groups, can be the cause of bias.</p>
<p><strong>Local conclusion:</strong> As we are interested in estimating the
effectiveness of the teaching program for students and pupils, we need
to be sure that groups are assigned randomly to avoid the bias. Before
starting the analysis, we should measure the level of imbalance between
the treatment and control groups and, should the personal differences be
statistically significant, control for them.</p>
<p>In order to check the existence of confounding effect, the balance
diagnostics should be performed on all possible confounding variables.
We can use the Chi-squared test of independence for categorical
variables (gender and overall grade), and ANOVA for numeric variable
<code>Math.grade</code> and <code>age</code>.</p>
<blockquote>
<p>Chi-squared test result</p>
</blockquote>
<table>
<thead>
<tr>
<th>Variable</th>
<th>ChiSquare</th>
<th>P.value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gender</td>
<td>0.012</td>
<td>0.9142</td>
</tr>
<tr>
<td>Overall.Grade</td>
<td>11.150</td>
<td>0.0038</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ANOVA results</p>
</blockquote>
<table>
<thead>
<tr>
<th>Variable</th>
<th>F</th>
<th>P.value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Math.Grade</td>
<td>30.615</td>
<td>0.0000</td>
</tr>
<tr>
<td>Age</td>
<td>5.853</td>
<td>0.0157</td>
</tr>
</tbody>
</table>
<p>For variables with the p &gt; .05 , we do not reject the null hypothesis
of independence of variables. We can conclude that the groups are
independent from the gender at .05 significance level. However, the
statistics for the remaining variables show that students in different
groups (treatment and control) have different personal characteristics.
To avoid being overly technical, we can describe the problem of the
randomization through the graphs below:</p>
<p><img src="../Propensity-Score-Matching/unnamed-chunk-10-1.png" alt=""></p>
<p>The graphs illustrate that the distribution of students by gender in
both groups are similar, however, the median value of math grade of
students in the treatment group is noticeably higher and they had
obtained higher math grades the previous semester.</p>
<p><img src="../Propensity-Score-Matching/unnamed-chunk-12-1.png" alt=""></p>
<p>The students/pupils in the control group are older and their overall
grades are lower in comparison with the students in the treatment group.
The problem is in the sectional bias, so we need to adjust it. In the
observational studies, treatment selection is often influenced by
subject characteristics. Suppose, we did the regression above and
inferred that the treatment effect of teaching how to play the game of
chess is valid. However, there is a possibility that the effect is
significant and positive not as a result of efficient seminars, but
because apriori the treatment group “contains” students with “better”
characteristics: the ability to learn “faster”, or which are quite
favored to know/learn more. Thus, this is not the pure effect of
seminars, because baseline characteristics of students differ
systematically from those of untreated students. What should be done?
The answer is to <em>randomize</em> the existing data.</p>
<hr>
<h1 id="the-solution">The solution</h1>
<h2 id="propensity-scores">Propensity scores</h2>
<p>There are different ways of performing randomization. In this case, we
will discuss the method called Propensity Score Matching (PSM), normally
used in pharmacoepidemiologic researche containing large healthcare
databases. We need to calculate some scores (propensity score) and
classify students according to these scores. In a <em>randomized study</em> the
propensity score is known: if the treatment was assigned randomly, then
the propensity score for each subject is 0.5. However, in <em>observational
(or nonrandomized) studies</em>, we need to estimate the fitted values for
scores. The question is why do we need to estimate the probability that
a subject receives a certain treatment since we already have these
groups? The answer is that to have the pure effect of treatment we want
to do randomization artificially, and the propensity score is not known.
After obtaining this score we will find two subjects: one in the treated
group and one in the control, with the <strong>same or similar</strong> propensity
scores. Then we can imagine that these two subjects were “randomly”
assigned to each group in the sense of being equally likely to be
treated or to be in the control group.</p>
<p>The propensity score is the estimated conditional probability
(propensity) of receiving treatment based on the covariates included in
the propensity score model:$PS = P(X=1|Z=z),$ where <code>PS</code> is propensity score, X is the binary variable with 0 value,
if the student is in the control group and, <code>X = 1</code>, then a student is
in the treatment group, and <code>Z</code> is covariates (student characteristics).</p>
<p>The propensity score is most often (not always[2]) estimated using a
logistic regression model, where treatment status is regressed on a
common set of explanatory variables (gender, age, math grade, overall
grade of a student), such as:</p>
<p>$log \frac{P(X = 1)}{1-P(X = 1)} = \beta_0 + \beta_1Z_1 +&hellip;+\beta_kZ_k$</p>
<p>The propensity score plays an important role in balancing the study
groups to make the treated and untreated groups comparable. The authors
of this method, <a href="https://www.stat.cmu.edu/~ryantibs/journalclub/rosenbaum_1983.pdf">Rosenbaum and
Rubin</a>,
showed that treated and untreated subjects with the same propensity
scores have identical distributions for all background covariates, which
is quite intuitive. Exact adjustments using the propensity score will,
on average, remove the bias in the baseline variables. We can divide the
sample into subgroups, for example quintiles, based on the propensity
scores. As Rosenbaum states, in matching we find a subset of untreated
individuals whose propensity scores are similar to those of the treated
persons, or vice-versa. The <strong>goal</strong> of matching is to create a dataset
that looks closer to the one that would result from a possibly
randomized experiment. Note that in matching we use the propensity
scores rather than all covariates individually, so we have a chance to
control for many confounding factors simultaneously by matching on a
single scalar variable.</p>
<h2 id="matching">Matching</h2>
<p>The propensity score can be used to reduce confounding via <strong>matching</strong>,
stratification, regression adjustment, or any combination of these
strategies. Let us now consider the matching. Matching is a common
technique used to select students for the control group who are matched
with the students from the treated group on background covariates. So,
after the estimating score individuals with similar estimated propensity
scores will be chosen and they will have, on average, similar chances of
receiving the treatment. Note that even if the propensity score is
similar, they may have different patterns of covariates at an individual
level. To that end, we need the <strong>distribution of covariates</strong> to be the
<strong>similar</strong> within the matched treated and control groups.</p>
<p><img src="../Propensity-Score-Matching/PsmDensity.PNG" alt="">
For more details see Schneeweiss S. A basic  study design for expedited safety signal evaluation based on electronic healthcare data.</p>
<p>On the left extreme end of the distributions are the students and pupils
from the control group with a low probability of being included in the
treatment group. On the right extreme one we can notice the students
from the treatment group with a very high probability of being treated.
Conversely, the overlapping area will identify students/pupils who have
comparable propensity scores among treated and control students and are
therefore better candidates for inclusion in a comparative analysis.
After the matching, the distribution of observed baseline covariates
that were considered in the propensity score model must be similar.</p>
<p>The most common implementation of propensity score matching is
<em>one-to-one</em> or pair matching, in which pairs of treated and untreated
subjects are formed in a way that matched subjects have similar values
of the propensity score. Although one-to-one matching appears to be the
most common approach to propensity score matching, other approaches can
also be used. The next common method for matching is the <em>nearest
neighbour</em> matching. Nearest neighbour matching selects for matching to
a given treated subject that untreated subject whose propensity score is
closest to that of the treated subject. If multiple untreated subjects
have propensity scores that are equally close to that of the treated
subject, one of these untreated subjects is selected randomly (Patorno,
Grotta et al.). Rassen et al. have shown that a variation of the
nearest-neighbor matching algorithm, the pairwise nearest-neighbor
matching algorithm, is computationally fast and provides better balance
among the treatment groups. That is why we use this method in our
calculations. Let us now return to our case study. Before taking any
randomization steps we have the following proportion of groups:</p>
<table>
<thead>
<tr>
<th>Control</th>
<th>Treatment</th>
</tr>
</thead>
<tbody>
<tr>
<td>554</td>
<td>367</td>
</tr>
</tbody>
</table>
<p>To show the result of propensity score matching, we will use the R
programming language. In R, Ho et al. developed the package MatchIt
(available from the <a href="http://CRAN.R-project.org/package=MatchIt">Comprehensive R Archive
Network</a>), which implements
different types of matching algorithms and provides various tools to
assess the balance of data. <a href="https://imai.fas.harvard.edu/research/files/matchit.pdf">From the R
journal</a>:
MatchIt is designed for causal inference with a dichotomous treatment
variable and a set of pretreatment control variables. Any number or type
of dependent variables can be used. MatchIt is usually used for
observational studies where the treatment variable is not randomly
assigned by the investigator, or the random assignment goes wrong. The
main command matchit() implements the matching procedures. Here is the
simple case for balancing the data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span> ChessWide <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;chess.csv&#34;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Use install.packages(&#34;MatchIt&#34;) to install the package</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">library</span>(MatchIt)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Changing the labels of target variable for matchit() function.</span>
</span></span><span style="display:flex;"><span> ChessWide<span style="color:#f92672">$</span>Treatment.Type <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(ChessWide<span style="color:#f92672">$</span>Treatment.Type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Control&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Data will be matched without one variable (Gender).</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Different matched data can be obtained, for reproducible result the set.seed is used.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">2708</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># The dependent variable is dichotomous treatment variable.</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># The covariates are pre-treatment characteristics of students.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># This command creates the MatchIt object called match.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> match <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matchit</span>(Treatment.Type <span style="color:#f92672">~</span> Age <span style="color:#f92672">+</span> Math.Grade <span style="color:#f92672">+</span> Overall.Grade, 
</span></span><span style="display:flex;"><span> data <span style="color:#f92672">=</span> ChessWide, method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nearest&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># The function match.data() is used to create the matched data from the MatchIt.</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># output object by excluding unmatched units from the original data.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> matcheddata <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">match.data</span>(match)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Creating function for comparison (results of Chi-squared and ANOVA tests).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> comparetable <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(data){
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span> pacman<span style="color:#f92672">::</span><span style="color:#a6e22e">p_load</span>(tableone)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> tab <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">CreateTableOne</span>( vars <span style="color:#f92672">=</span>  <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Gender&#34;</span>, <span style="color:#e6db74">&#34;Age&#34;</span>, <span style="color:#e6db74">&#34;Math.Grade&#34;</span>, <span style="color:#e6db74">&#34;Overall.Grade&#34;</span>), 
</span></span><span style="display:flex;"><span>      data <span style="color:#f92672">=</span> data, 
</span></span><span style="display:flex;"><span>      factorVars <span style="color:#f92672">=</span>  <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Gender&#34;</span>, <span style="color:#e6db74">&#34;Overall.Grade&#34;</span>), 
</span></span><span style="display:flex;"><span>      strata <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Treatment.Type&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> tab <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">print</span>(tab, printToggle <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, noSpaces <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
</span></span><span style="display:flex;"><span> tab[,<span style="color:#ae81ff">-4</span>]
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Relabel the data and see the result.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> matcheddata<span style="color:#f92672">$</span>Treatment.Type <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(matcheddata<span style="color:#f92672">$</span>Treatment.Type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;Control&#34;</span>, <span style="color:#e6db74">&#34;Treatment&#34;</span>)
</span></span><span style="display:flex;"><span> knitr<span style="color:#f92672">::</span><span style="color:#a6e22e">kable</span>(<span style="color:#a6e22e">comparetable</span>(matcheddata)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span> kableExtra<span style="color:#f92672">::</span><span style="color:#a6e22e">kable_styling</span>(bootstrap_options <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;striped&#34;</span>, full_width <span style="color:#f92672">=</span> F)
</span></span></code></pre></div><table>
<thead>
<tr>
<th></th>
<th>Control</th>
<th>Treatment</th>
<th>p</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>367</td>
<td>367</td>
<td></td>
</tr>
<tr>
<td>Gender = Girl (%)</td>
<td>177 (48.2)</td>
<td>185 (50.4)</td>
<td>0.605</td>
</tr>
<tr>
<td>Age (mean (SD))</td>
<td>15.41 (5.47)</td>
<td>15.40 (5.74)</td>
<td>0.979</td>
</tr>
<tr>
<td>Math.Grade (mean (SD))</td>
<td>7.73 (1.25)</td>
<td>7.83 (1.33)</td>
<td>0.305</td>
</tr>
<tr>
<td>Overall.Grade (%)</td>
<td></td>
<td></td>
<td>0.568</td>
</tr>
<tr>
<td>Average</td>
<td>161 (43.9)</td>
<td>148 (40.3)</td>
<td></td>
</tr>
<tr>
<td>Excellent</td>
<td>164 (44.7)</td>
<td>178 (48.5)</td>
<td></td>
</tr>
<tr>
<td>Poor</td>
<td>42 (11.4)</td>
<td>41 (11.2)</td>
<td></td>
</tr>
</tbody>
</table>
<p><code>Treatment.Type</code> is the dichotomous treatment variable,
<code>Gender, Age, Math.grade, Overall.Grade</code> pre-treatment covariates, all
of which are contained in the data frame ChessWide[3]. The dependent
variable may be included in ChessWide for convenience but is never used
by MatchIt or included in the formula.</p>
<p><img src="../Propensity-Score-Matching/unnamed-chunk-16-1.png" alt=""></p>
<p><img src="../Propensity-Score-Matching/unnamed-chunk-18-1.png" alt=""></p>
<p>The distribution of variables across treatment and control group is
relatively similar, the test result also indicates that there is no
significant difference between groups on personal characteristics of
students. The effect of the treatment can now be estimated as the
difference between the average outcome for treated students and the mean
outcome for untreated students in the matched sample. Although there is
no noticeable difference between results, the second parametric analysis
is more reliable because it is based on matched data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#75715e"># For regression analysis we use the data in the long format</span>
</span></span><span style="display:flex;"><span> MLong <span style="color:#f92672">&lt;-</span> tidyr<span style="color:#f92672">::</span><span style="color:#a6e22e">gather</span>(matcheddata, PrePost, Answers, <span style="color:#a6e22e">c</span>(Pre,Post), factor_key<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>) 
</span></span><span style="display:flex;"><span>  matchedmodel <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(Answers <span style="color:#f92672">~</span> Treatment.Type <span style="color:#f92672">+</span> PrePost <span style="color:#f92672">+</span> Treatment.Type <span style="color:#f92672">*</span> PrePost, 
</span></span><span style="display:flex;"><span>  data <span style="color:#f92672">=</span> MLong)
</span></span><span style="display:flex;"><span>     stargazer<span style="color:#f92672">::</span><span style="color:#a6e22e">stargazer</span>(matchedmodel,
</span></span><span style="display:flex;"><span>        title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DID Results&#34;</span>,
</span></span><span style="display:flex;"><span>        dep.var.labels <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Answers&#34;</span>),
</span></span><span style="display:flex;"><span>        out<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;models.htm&#34;</span>,
</span></span><span style="display:flex;"><span>        type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>        header<span style="color:#f92672">=</span><span style="color:#66d9ef">FALSE</span>, 
</span></span><span style="display:flex;"><span>        covariate.labels <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Group (Treatment)&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Time (Post)&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Group * Time (Treatment * Post)&#34;</span>
</span></span><span style="display:flex;"><span>        ))
</span></span></code></pre></div><pre><code>## 
## DID Results
## ===========================================================
##                                     Dependent variable:    
##                                 ---------------------------
##                                           Answers          
## -----------------------------------------------------------
## Group (Treatment)                          0.357           
##                                           (0.393)          
##                                                            
## Time (Post)                              -0.834**          
##                                           (0.393)          
##                                                            
## Group * Time (Treatment * Post)          12.787***         
##                                           (0.556)          
##                                                            
## Constant                                 12.381***         
##                                           (0.278)          
##                                                            
## -----------------------------------------------------------
## Observations                               1,468           
## R2                                         0.509           
## Adjusted R2                                0.508           
## Residual Std. Error                  5.329 (df = 1464)     
## F Statistic                      505.610*** (df = 3; 1464) 
## ===========================================================
## Note:                           *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01
</code></pre>
<hr>
<h1 id="conclusion">Conclusion</h1>
<p>All in all, randomization is a popular method to block or minimize
potential imbalance between the treatment and control groups in order to
control the confounding. We used popular method Propensity score
matching for providing the random or pseudorandom data for analysis. The
basic steps for PSM implementation are:</p>
<ol>
<li>
<p>Fit the logit (or other) model, where the dependent variable is
treatment groups and the independent variables are confounding
variables.</p>
</li>
<li>
<p>Split the sample into user-defined k intervals of the propensity
scores.</p>
</li>
<li>
<p>Within each interval, run a test to assure that the average
propensity score of control and treated units does not differ.</p>
</li>
<li>
<p>If the test fails in one interval, split the interval in half and
test again.</p>
</li>
<li>
<p>Continue until the distribution is equal in both groups.</p>
</li>
<li>
<p>Test the difference (using average value or proportion) for
characteristics to determine the difference between groups.</p>
</li>
<li>
<p>Conduct the parametric (or other) analysis using the matched
balanced data</p>
</li>
</ol>
<p>It seems that PSM is an ideal method for balancing data. However,
authors state some drawbacks in PSM. One of them is that the results of
using the propensity scores are conditional <strong>only</strong> on the observed
covariates. Thus, unmeasured confounding bias cannot be excluded. Other
illustrations of PSM drawbacks may be found
<a href="https://gking.harvard.edu/files/gking/files/psnot.pdf">here</a>.</p>
<hr>
<h1 id="reference-list">Reference List</h1>
<blockquote>
<p><em>P. Rosenbaum, D. Rubin, “The Central Role of the Propensity Score in
Observational Studies for Causal Effects.”</em></p>
</blockquote>
<blockquote>
<p><em>E. Patorno, Al. Grotta, et al, “Propensity score methodology for
confounding control in health care utilization databases.”</em></p>
</blockquote>
<blockquote>
<p><em>S. Schneeweiss, “A basic study design for expedited safety signal
evaluation based on electronic healthcare data.”</em></p>
</blockquote>
<hr>
<p>[1] Chess became a compulsory subject in the national school curriculum
of Armenia since 2011</p>
<p>[2] The use of bagging or boosting, recursive partitioning or tree-based
methods, random forests and other methods for estimating the propensity
score can be examined.</p>
<p>[3] The long format of data is for regression analysis, and wide format
for matching and visualization.</p>

                
            </div>
        </div>
            
            
                <div class="card-footer text-muted">
                   
                
                <div class="blog-tags">
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/data-analysis/">Data Analysis</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/propensity-score-matching/">Propensity Score Matching</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/chess/">Chess</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/experimental-studies/">Experimental Studies</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/bias-in-research/">Bias in Research</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/statistical-methods/">Statistical Methods</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/cognitive-development/">Cognitive Development</a>
                  
                  <a href="https://DatamotusBlog.netlify.app//tags/logical-thinking/">Logical Thinking</a>
                  
                </div>
                
              </div>


 
    </div>
</div>
    

  </div>
</div>

<div class="container">
  <div class="row font-sans">
    <div class="col-md-12 mt-10">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-end">
          
        </ul>
      </nav>
    </div>
  </div>
</div>


    
    <script src="/node_modules/iframe-resizer/js/iframeResizer.contentWindow.min.js"></script>
   

  </body>
</html>
